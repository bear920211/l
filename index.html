<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU å¯¦å¢ƒåŠŸå¾·åœ°åœ– Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }

        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; cursor: crosshair;
        }

        #shapes-layer { position: absolute; inset: 0; z-index: 80; pointer-events: none; }
        #pins-layer { position: absolute; inset: 0; z-index: 90; pointer-events: none; }

        .building-shape { position: absolute; transform-origin: center center; pointer-events: auto; background: transparent; }
        .admin-view .building-shape { border: 1px dashed rgba(79, 70, 229, 0.4); }

        .s-rect { border-radius: 2px; }
        .s-capsule { border-radius: 999px !important; }
        .s-ellipse { border-radius: 50% !important; }
        
        /* ä¸‰è§’å½¢ä¿®æ­£ï¼šç¢ºä¿èƒŒæ™¯è‰²æ’æ»¿å®¹å™¨ä»¥ä¾¿æ—‹è½‰æ™‚åˆ¤å®š */
        .s-triangle { 
            clip-path: polygon(0 0, 100% 0, 0 100%); 
            background: transparent; 
        }

        .selected-shape { 
            border: 2px solid #4f46e5 !important; 
            background: rgba(79, 70, 229, 0.2) !important; 
            z-index: 100 !important; 
        }

        /* é¸ä¸­ä¸‰è§’å½¢æ™‚ï¼Œè®“èƒŒæ™¯è‰²é¡¯ç¤ºä»¥åˆ©ç·¨è¼¯ */
        .selected-shape.s-triangle { background: rgba(79, 70, 229, 0.4) !important; }

        .handle { position: absolute; width: 12px; height: 12px; background: #fff; border: 2px solid #4f46e5; border-radius: 50%; z-index: 110; }
        .rotate-handle { position: absolute; width: 16px; height: 16px; background: #4f46e5; border: 2px solid #fff; border-radius: 50%; top: -35px; left: 50%; transform: translateX(-50%); cursor: grab; }
        .rotate-line { position: absolute; width: 2px; height: 25px; background: #4f46e5; top: -25px; left: 50%; transform: translateX(-50%); }

        .tool-btn { @apply px-3 py-2 rounded-xl text-[11px] text-white font-bold transition-all hover:scale-105; }
        .floating-pin { animation: float 2s ease-in-out infinite; position: absolute; pointer-events: none; transform: translate(-50%, -100%); z-index: 70; }
        @keyframes float { 0%, 100% { transform: translate(-50%, -100%) translateY(0px); } 50% { transform: translate(-50%, -100%) translateY(-10px); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ğŸ’ NTCU åŠŸå¾·åœ°åœ– <button id="admin-trigger" class="opacity-0">.</button></h1>
                <p class="text-slate-500 text-sm">ä¸‰è§’å½¢æ—‹è½‰åŠŸèƒ½å·²ä¿®æ­£ã€‚</p>
            </div>
            <div class="flex bg-white p-3 rounded-3xl shadow-sm border border-slate-100 gap-6">
                <div class="text-right items-end flex flex-col"><span class="text-[9px] font-black text-slate-400">HERO</span><span id="hero-name" class="font-bold text-slate-700">è¨ªå®¢</span></div>
                <div class="text-right items-end flex flex-col"><span class="text-[9px] font-black text-slate-400">MERIT</span><span id="hero-merit" class="text-xl font-black text-indigo-600">0</span></div>
            </div>
        </header>

        <div id="admin-tools" class="hidden mb-6 p-4 bg-slate-900 rounded-3xl flex flex-wrap items-center justify-between gap-4">
            <div class="flex gap-2">
                <button onclick="setTool('rect')" class="tool-btn bg-indigo-600">ï¼‹ çŸ©å½¢</button>
                <button onclick="setTool('capsule')" class="tool-btn bg-purple-600">ï¼‹ è† å›Š</button>
                <button onclick="setTool('ellipse')" class="tool-btn bg-pink-600">ï¼‹ æ©¢åœ“</button>
                <button onclick="setTool('triangle')" class="tool-btn bg-amber-600">ï¼‹ ä¸‰è§’å½¢</button>
            </div>
            <button onclick="toggleAdmin(false)" class="bg-white/10 text-white text-xs px-4 py-1.5 rounded-xl">çµæŸç·¨è¼¯</button>
        </div>

        <div id="map-root" class="map-container">
            <div id="shapes-layer"></div>
            <div id="pins-layer"></div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[200] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full p-8 shadow-2xl text-center">
            <div id="location-name" class="inline-block bg-indigo-50 text-indigo-700 text-xs font-black px-4 py-2 rounded-full mb-4">æ ¡åœ’å€åŸŸ</div>
            <input type="text" id="in-item" placeholder="ç™¼ç¾äº†ä»€éº¼ï¼Ÿ" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl mb-4 font-bold outline-none">
            <button id="btn-submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg">æäº¤æ¨™è¨˜</button>
            <button onclick="closeModals()" class="w-full text-slate-400 font-bold py-2 text-xs mt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let buildings = [], selectedId = null, isAdmin = false;
        let isDragging = false, isRotating = false, isResizing = false;
        let currentHandle = null, startPos = { x:0, y:0 }, adminClicks = 0;

        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });

        // ç²¾æº–çš„å¹¾ä½•åˆ¤å®š (åŒ…å«ä¸‰è§’å½¢æ—‹è½‰å¾Œçš„åº§æ¨™è½‰æ›)
        function isPointInShape(px, py, box) {
            const rad = -box.angle * Math.PI / 180;
            const cx = box.x + box.w / 2;
            const cy = box.y + box.h / 2;
            
            // è½‰æ›ç‚ºå±€éƒ¨åº§æ¨™ (rx, ry)
            const rx = (px - cx) * Math.cos(rad) - (py - cy) * Math.sin(rad);
            const ry = (px - cx) * Math.sin(rad) + (py - cy) * Math.cos(rad);

            if (box.type === 'rect') return Math.abs(rx) <= box.w/2 && Math.abs(ry) <= box.h/2;
            if (box.type === 'ellipse') return (Math.pow(rx, 2) / Math.pow(box.w/2, 2)) + (Math.pow(ry, 2) / Math.pow(box.h/2, 2)) <= 1;
            if (box.type === 'triangle') {
                const lx = rx + box.w/2; 
                const ly = ry + box.h/2;
                return (lx >= 0 && ly >= 0 && lx <= box.w && ly <= box.h && (lx/box.w + ly/box.h <= 1));
            }
            return false;
        }

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach((b, i) => {
                const el = document.createElement('div');
                el.className = `building-shape ${selectedId === i ? 'selected-shape' : ''} s-${b.type}`;
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg);`;
                
                if (isAdmin && selectedId === i) {
                    el.innerHTML = `
                        <div class="rotate-line"></div>
                        <div class="rotate-handle" onmousedown="window.startRotate(event)"></div>
                        <div class="handle" style="bottom:-6px;right:-6px;cursor:se-resize" onmousedown="window.startResize(event,'se')"></div>`;
                }
                
                el.onmousedown = (e) => {
                    e.stopPropagation();
                    if (isAdmin) { selectedId = i; isDragging = true; startPos = getMousePos(e); renderShapes(); }
                    else { 
                        const pos = getMousePos(e);
                        if(isPointInShape(pos.x, pos.y, b)) {
                            document.getElementById('location-name').innerText = `ğŸ“ ${b.name}`;
                            document.getElementById('report-modal').classList.remove('hidden');
                        }
                    }
                };
                layer.appendChild(el);
            });
        }

        window.addEventListener('mousemove', (e) => {
            if (!isAdmin || selectedId === null) return;
            const cur = getMousePos(e), b = buildings[selectedId];
            if (isDragging) { b.x += (cur.x - startPos.x); b.y += (cur.y - startPos.y); }
            else if (isRotating) { 
                const cx = b.x + b.w/2, cy = b.y + b.h/2;
                b.angle = Math.atan2(cur.y - cy, cur.x - cx) * 180 / Math.PI + 90;
            }
            else if (isResizing) { 
                b.w = Math.max(2, b.w + (cur.x - (b.x + b.w)));
                b.h = Math.max(2, b.h + (cur.y - (b.y + b.h)));
            }
            startPos = cur;
            renderShapes();
        });

        window.addEventListener('mouseup', async () => { 
            if (isDragging || isRotating || isResizing) { 
                await setDoc(CAMPUS_DOC, { buildings }); 
                isDragging = isRotating = isResizing = false; 
            } 
        });

        window.startRotate = (e) => { e.stopPropagation(); isRotating = true; };
        window.startResize = (e) => { e.stopPropagation(); isResizing = true; };
        window.setTool = (type) => { 
            const n = prompt("å€åŸŸåç¨±ï¼š"); 
            if(n) { 
                buildings.push({ x:40, y:40, w:15, h:15, angle:0, name:n, type }); 
                selectedId = buildings.length - 1;
                renderShapes();
            } 
        };
        window.toggleAdmin = (s) => { isAdmin = s; document.getElementById('admin-tools').classList.toggle('hidden', !s); document.getElementById('map-root').classList.toggle('admin-view', s); selectedId = null; renderShapes(); };
        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
        document.getElementById('admin-trigger').onclick = () => { adminClicks++; if(adminClicks >= 5) toggleAdmin(true); };
        function getMousePos(e) { const r = document.getElementById('map-root').getBoundingClientRect(); return { x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100 }; }
    </script>
</body>
</html>
