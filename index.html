<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU ä½ ä¸Ÿæˆ‘æ’¿ - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: hidden; cursor: crosshair;
        }
        #shapes-layer, #pins-layer { position: absolute; inset: 0; pointer-events: none; }
        #shapes-layer { z-index: 80; }
        #pins-layer { z-index: 90; }
        .building-shape { position: absolute; transform-origin: center; pointer-events: auto; background: transparent; }
        .s-rect { border-radius: 2px; }
        .s-capsule { border-radius: 999px !important; }
        .s-ellipse { border-radius: 50% !important; }
        .floating-pin { animation: float 2s ease-in-out infinite; position: absolute; transform: translate(-50%, -100%); }
        @keyframes float { 0%, 100% { transform: translate(-50%, -100%) translateY(0px); } 50% { transform: translate(-50%, -100%) translateY(-10px); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ğŸ’ NTCU ä½ ä¸Ÿæˆ‘æ’¿</h1>
                <p class="text-slate-500 text-sm">é»æ“Šåœ°åœ–æ¨™è¨»éºå¤±ç‰© (å… Storage ç©©å®šç‰ˆ)</p>
            </div>
            <div class="bg-white p-3 px-6 rounded-3xl shadow-sm border border-slate-100 text-right">
                <span class="text-[9px] font-black text-slate-400 block">TOP HERO</span>
                <span id="top-hero-name" class="text-xl font-black text-indigo-600">è¼‰å…¥ä¸­...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                <div id="map-root" class="map-container" onclick="handleMapClick(event)">
                    <div id="shapes-layer"></div>
                    <div id="pins-layer"></div>
                </div>
            </div>
            <div class="lg:col-span-4 flex flex-col gap-6">
                <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl">
                    <h3 class="font-bold mb-4 flex justify-between items-center">ğŸ† åŠŸå¾·æ¦œ</h3>
                    <div id="leaderboard" class="space-y-3 text-xs"></div>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-sm border h-[400px] flex flex-col overflow-hidden">
                    <div class="p-5 border-b bg-slate-50 font-black text-slate-600 text-sm flex justify-between">
                        <span>å¾…èªé ˜æ¸…å–®</span>
                        <span id="items-count" class="text-indigo-500">0</span>
                    </div>
                    <div id="items-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-[300] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full p-8 shadow-2xl text-center">
            <span id="location-name" class="inline-block bg-indigo-50 text-indigo-600 text-xs font-black px-5 py-2 rounded-full mb-6">ğŸ“ å®šä½ä¸­...</span>
            <div class="space-y-3 mb-6">
                <input type="text" id="in-nick" placeholder="æ‚¨çš„è‹±é›„æš±ç¨± (å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                <input type="text" id="in-item" placeholder="ç™¼ç¾äº†ä»€éº¼ï¼Ÿ (å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                <input type="text" id="in-floor" placeholder="å…·é«”ä½ç½® (ä¾‹ï¼š3æ¨“302æ•™å®¤å‰é–€)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                <input type="text" id="in-desc" placeholder="è©³ç´°æè¿° (ç‰©å“ç‰¹å¾µã€é¡è‰²)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-100">
                
                <div class="p-3 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:bg-slate-50" onclick="document.getElementById('in-file').click()">
                    <input type="file" id="in-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <div id="preview-container" class="hidden"><img id="img-preview" src="" class="rounded-xl mx-auto max-h-32 object-cover"></div>
                    <div id="upload-placeholder" class="text-slate-400 text-[10px] py-2">ğŸ“· é»æ“Šæ‹ä¸‹ç…§ç‰‡ (è«‹å°æ–¼ 800KB)</div>
                </div>
            </div>
            <button id="btn-submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg">ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)</button>
            <button onclick="closeModals()" class="mt-4 text-slate-400 font-bold text-xs">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[400] p-4 backdrop-blur-md">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full overflow-hidden shadow-2xl">
            <div class="w-full h-56 bg-slate-100 flex items-center justify-center overflow-hidden">
                <img id="detail-img" src="" class="w-full h-full object-cover">
                <div id="no-img-placeholder" class="hidden text-slate-300 font-bold text-sm">ğŸ“· ç„¡ç…§ç‰‡é è¦½</div>
            </div>
            <div class="p-8">
                <h2 id="detail-name" class="text-2xl font-black text-slate-800">ç‰©å“åç¨±</h2>
                <p id="detail-loc" class="text-indigo-500 font-bold text-sm mb-4">ğŸ“ ä½ç½®</p>
                <div class="space-y-4 mb-6 text-left">
                    <div class="bg-indigo-50 rounded-xl p-4">
                        <p class="text-[9px] text-indigo-400 font-black mb-1">å…·é«”ä½ç½®</p>
                        <p id="detail-floor" class="text-indigo-800 font-bold text-sm"></p>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4">
                        <p class="text-[9px] text-slate-400 font-black mb-1">æè¿° / æ‹¾ç²è€…ï¼š<span id="detail-finder"></span></p>
                        <p id="detail-desc" class="text-slate-600 text-sm"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-claim-now" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg">ç¢ºèªèªé ˜</button>
                    <button onclick="closeDetail()" class="px-6 py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");
        const LOST_COLL = collection(db, "lost_items_v2");
        const USER_COLL = collection(db, "users_v2");

        let buildings = [], lostItems = [], clickPos = {x:50, y:50};

        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
        onSnapshot(LOST_COLL, (s) => { 
            lostItems = s.docs.map(d => ({ id: d.id, ...d.data() })); 
            document.getElementById('items-count').innerText = lostItems.length;
            renderPins(); renderList(); 
        });
        onSnapshot(query(USER_COLL, orderBy("merit", "desc"), limit(5)), (s) => {
            const list = s.docs.map((d, i) => `<div class="flex justify-between p-2 bg-white/10 rounded-xl"><span>${i+1}. ${d.id}</span><b>${d.data().merit || 0} pts</b></div>`).join('');
            document.getElementById('leaderboard').innerHTML = list || "å°šç„¡æ’å";
            if(s.docs[0]) document.getElementById('top-hero-name').innerText = s.docs[0].id;
        });

        window.handleMapClick = (e) => {
            const r = document.getElementById('map-root').getBoundingClientRect();
            clickPos = { x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100 };
            let hit = buildings.find(b => isPointInShape(clickPos.x, clickPos.y, b));
            document.getElementById('location-name').innerText = `ğŸ“ ${hit ? hit.name : "æ ¡åœ’é–‹æ”¾å€åŸŸ"}`;
            
            document.getElementById('in-nick').value = ""; 
            document.getElementById('in-item').value = "";
            document.getElementById('in-floor').value = "";
            document.getElementById('in-desc').value = ""; 
            document.getElementById('in-file').value = "";
            document.getElementById('img-preview').src = "";
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('report-modal').classList.remove('hidden');
        };

        document.getElementById('in-nick').onblur = async function() {
            const n = this.value.trim(); if(!n) return;
            const snap = await getDoc(doc(USER_COLL, n));
            if(snap.exists()) alert(`ğŸ” åµæ¸¬åˆ°å‚³å¥‡äººç‰©ï¼\nã€Œ${n}ã€ç›®å‰å·²ç´¯ç© ${snap.data().merit || 0} åŠŸå¾·ã€‚\næ­¡è¿å›ä¾†ï¼`);
        };

        window.previewImage = (input) => {
            const f = input.files[0]; if(!f) return;
            if(f.size > 850000) { alert("ç…§ç‰‡å¤ªå¤§å›‰ï¼è«‹å°æ–¼ 800KB"); input.value = ""; return; }
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(f);
        };

        document.getElementById('btn-submit').onclick = async () => {
            const nick = document.getElementById('in-nick').value.trim();
            const item = document.getElementById('in-item').value.trim();
            const floor = document.getElementById('in-floor').value.trim();
            const desc = document.getElementById('in-desc').value.trim();
            const imgData = document.getElementById('img-preview').src;

            if(!nick || !item) return alert("æš±ç¨±èˆ‡ç‰©å“åç¨±å¿…å¡«ï¼");

            const btn = document.getElementById('btn-submit');
            btn.innerText = "ä¸Šå‚³ä¸­..."; btn.disabled = true;

            try {
                await setDoc(doc(LOST_COLL), { 
                    name: item, finder: nick, description: desc, floor_info: floor,
                    location: document.getElementById('location-name').innerText.replace('ğŸ“ ',''),
                    imageUrl: imgData.startsWith('data:image') ? imgData : "",
                    x: clickPos.x, y: clickPos.y, time: Date.now() 
                });
                await setDoc(doc(USER_COLL, nick), { merit: increment(50) }, { merge: true });
                closeModals();
            } catch (err) { alert("å„²å­˜å¤±æ•—ï¼"); }
            btn.innerText = "ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)"; btn.disabled = false;
        };

        window.openDetail = (id) => {
            const item = lostItems.find(i => i.id === id); if(!item) return;
            document.getElementById('detail-name').innerText = item.name;
            document.getElementById('detail-loc').innerText = `ğŸ“ ${item.location}`;
            document.getElementById('detail-floor').innerText = item.floor_info || "å°šæœªæä¾›å…·é«”æ¨“å±¤";
            document.getElementById('detail-finder').innerText = item.finder;
            document.getElementById('detail-desc').innerText = item.description || "ç„¡æè¿°ã€‚";
            
            const img = document.getElementById('detail-img'), ph = document.getElementById('no-img-placeholder');
            if(item.imageUrl) { img.src = item.imageUrl; img.classList.remove('hidden'); ph.classList.add('hidden'); }
            else { img.classList.add('hidden'); ph.classList.remove('hidden'); }
            
            document.getElementById('btn-claim-now').onclick = () => claimItem(item.id, item.finder);
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        window.claimItem = async (id, f) => {
            if(confirm(`ç¢ºèªèªé ˜ï¼Ÿå°‡çµ¦äºˆã€Œ${f}ã€20 åŠŸå¾·ï¼`)) {
                await deleteDoc(doc(db, "lost_items_v2", id));
                await setDoc(doc(USER_COLL, f), { merit: increment(20) }, { merge: true });
                closeDetail();
            }
        };

        // --- æ ¸å¿ƒä¿®æ­£ï¼šç¸±å‘è† å›Šåˆ¤å®šé‚è¼¯ ---
        function isPointInShape(px, py, box) {
            const rad = -box.angle * Math.PI / 180;
            const cx = box.x + box.w / 2;
            const cy = box.y + box.h / 2;
            const rx = (px - cx) * Math.cos(rad) - (py - cy) * Math.sin(rad);
            const ry = (px - cx) * Math.sin(rad) + (py - cy) * Math.cos(rad);

            if (box.type === 'rect') return Math.abs(rx) <= box.w/2 && Math.abs(ry) <= box.h/2;
            if (box.type === 'ellipse') return (Math.pow(rx, 2)/Math.pow(box.w/2, 2)) + (Math.pow(ry, 2)/Math.pow(box.h/2, 2)) <= 1;
            
            if (box.type === 'capsule') {
                const r = Math.min(box.w, box.h) / 2;
                if (box.w >= box.h) {
                    if (Math.abs(ry) > r) return false;
                    const lineLen = box.w - 2 * r;
                    if (Math.abs(rx) <= lineLen / 2) return true;
                    const dx = Math.abs(rx) - lineLen / 2;
                    return (dx * dx + ry * ry) <= r * r;
                } else {
                    if (Math.abs(rx) > r) return false;
                    const lineLen = box.h - 2 * r;
                    if (Math.abs(ry) <= lineLen / 2) return true;
                    const dy = Math.abs(ry) - lineLen / 2;
                    return (rx * rx + dy * dy) <= r * r;
                }
            }
            return false;
        }

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach(b => {
                const el = document.createElement('div'); el.className = `building-shape s-${b.type}`;
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle||0}deg);`;
                layer.appendChild(el);
            });
        }
        function renderPins() {
            const layer = document.getElementById('pins-layer'); layer.innerHTML = '';
            lostItems.forEach(i => {
                const p = document.createElement('div'); p.className = 'floating-pin';
                p.style.left = `${i.x}%`; p.style.top = `${i.y}%`;
                p.innerHTML = `<div class="bg-indigo-600 text-white text-[9px] px-2 py-1 rounded shadow mb-1 font-bold">${i.name}</div><div class="w-3 h-3 bg-white rounded-full border-2 border-indigo-600 mx-auto"></div>`;
                layer.appendChild(p);
            });
        }
        function renderList() {
            document.getElementById('items-list').innerHTML = lostItems.map(i => `
                <div onclick="openDetail('${i.id}')" class="p-3 bg-white rounded-2xl border flex items-center gap-3 cursor-pointer hover:border-indigo-400">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex-shrink-0 flex items-center justify-center text-[8px] text-slate-300 overflow-hidden">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-full object-cover">` : 'ç„¡ç…§ç‰‡'}
                    </div>
                    <div class="flex-1"><div class="font-bold text-sm text-slate-700">${i.name}</div><div class="text-[9px] text-indigo-400 font-bold">ğŸ“ ${i.location}</div></div>
                </div>`).join('') || '<div class="text-center text-slate-300 text-xs py-10">å°šç„¡éºå¤±ç‰©</div>';
        }
        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
        window.closeDetail = () => document.getElementById('detail-modal').classList.add('hidden');
    </script>
</body>
</html>
