<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU äº’åŠ©æœƒ - ç›´æ¥æ–°å¢æ¨¡å¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: visible; cursor: crosshair; touch-action: none;
        }
        #shapes-layer { position: absolute; inset: 0; pointer-events: none; z-index: 80; }
        #pins-layer { position: absolute; inset: 0; pointer-events: none; z-index: 90; }
        
        /* ä¸‰è§’å½¢æ¨£å¼ */
        .building-shape { position: absolute; transform-origin: center; pointer-events: auto; }
        .is-triangle { 
            clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
            -webkit-clip-path: polygon(0% 0%, 0% 100%, 100% 100%);
        }

        /* ç·¨è¼¯æ§åˆ¶å™¨ */
        .transformer { position: absolute; border: 3px dashed #4f46e5; pointer-events: none; z-index: 2000; transform-origin: center; box-sizing: border-box; }
        .handle { position: absolute; width: 20px; height: 20px; background: white; border: 3px solid #4f46e5; border-radius: 50%; pointer-events: auto; }
        .rotate-handle { top: -40px; left: 50%; transform: translateX(-50%); background: #4f46e5; cursor: grab; }
        .resize-handle { bottom: -10px; right: -10px; cursor: nwse-resize; }
        
        /* æŒ‰éˆ•åˆ— */
        .edit-controls {
            position: absolute; bottom: -80px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; width: max-content; z-index: 2001;
        }
        .btn-edit { padding: 12px 24px; border-radius: 99px; font-weight: 900; cursor: pointer; color: white; box-shadow: 0 10px 15px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn-add { background: #6366f1; }
        .btn-save { background: #10b981; }
        .btn-edit:hover { transform: translateY(-2px); filter: brightness(1.1); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-black text-slate-800">ğŸ’ NTCU ä¸€ä¸Ÿä¸€æ’¿</h1>
            <p class="text-slate-500 text-sm">å¿«é€Ÿé€£é»åœ°åœ– 3 ä¸‹é€²å…¥ç·¨è¼¯æ¨¡å¼</p>
        </header>

        <div id="map-root" class="map-container" onmousedown="handleMouseDown(event)">
            <div id="shapes-layer"></div>
            <div id="pins-layer"></div>
            
            <div id="transformer" class="transformer hidden">
                <div class="handle rotate-handle" onmousedown="startRotate(event)"></div>
                <div class="handle resize-handle" onmousedown="startResize(event)"></div>
            </div>

            <div id="edit-ui" class="edit-controls hidden">
                <div class="btn-edit btn-add" onclick="addNewTriangle()">â• æ–°å¢ç’°å¢ƒæ¨“ä¸‰è§’å½¢</div>
                <div class="btn-edit btn-save" onclick="saveToFirebase()">ğŸ’¾ å„²å­˜æ‰€æœ‰é…ç½®</div>
            </div>
        </div>
        <p id="edit-hint" class="hidden mt-4 text-center text-red-500 font-bold">ğŸ›  ç·¨è¼¯æ¨¡å¼å·²é–‹å•Ÿ</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let buildings = [], editMode = false, selectedIdx = -1;
        let isDragging = false, isResizing = false, isRotating = false;
        let startX, startY, startW, startH, startAngle, centerX, centerY;

        // ç¢°æ’åµæ¸¬é‚è¼¯
        function checkHit(px, py, b) {
            if (b.name === "ç’°å¢ƒæ¨“") {
                const rad = (b.angle || 0) * Math.PI / 180;
                const cx = b.x + b.w/2, cy = b.y + b.h/2;
                const dx = px - cx, dy = py - cy;
                const rx = dx * Math.cos(-rad) - dy * Math.sin(-rad);
                const ry = dx * Math.sin(-rad) + dy * Math.cos(-rad);
                const x1 = -b.w/2, y1 = -b.h/2, x2 = -b.w/2, y2 = b.h/2, x3 = b.w/2, y3 = b.h/2;
                const getArea = (xa,ya,xb,yb,xc,yc) => Math.abs((xa*(yb-yc)+xb*(yc-ya)+xc*(ya-yb))/2);
                const total = getArea(x1,y1,x2,y2,x3,y3);
                return Math.abs(total - (getArea(rx,ry,x1,y1,x2,y2) + getArea(rx,ry,x2,y2,x3,y3) + getArea(rx,ry,x3,y3,x1,y1))) < 1.0;
            }
            return px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h;
        }

        // é€£é»ä¸‰ä¸‹åˆ‡æ›æ¨¡å¼
        window.addEventListener('click', (e) => {
            if (e.detail === 3) {
                editMode = !editMode;
                document.getElementById('edit-ui').classList.toggle('hidden');
                document.getElementById('edit-hint').classList.toggle('hidden');
                selectedIdx = -1; updateTransformer(); renderShapes();
            }
        });

        // æ–°å¢ä¸‰è§’å½¢æŒ‰éˆ•åŠŸèƒ½
        window.addNewTriangle = () => {
            const newObj = {
                name: "ç’°å¢ƒæ¨“",
                x: 40, y: 40, w: 15, h: 15, angle: 0
            };
            buildings.push(newObj);
            selectedIdx = buildings.length - 1; // è‡ªå‹•é¸ä¸­æ–°ç”¢ç”Ÿçš„
            updateTransformer();
            renderShapes();
        };

        window.handleMouseDown = (e) => {
            if (!editMode) return;
            const r = document.getElementById('map-root').getBoundingClientRect();
            const px = ((e.clientX - r.left) / r.width) * 100;
            const py = ((e.clientY - r.top) / r.height) * 100;
            const hitIdx = buildings.findIndex(b => checkHit(px, py, b));

            if (hitIdx !== -1) {
                selectedIdx = hitIdx; isDragging = true;
                startX = e.clientX; startY = e.clientY;
                updateTransformer();
                renderShapes();
            }
        };

        // æ—‹è½‰ã€ç¸®æ”¾èˆ‡ç§»å‹•è™•ç†
        window.startResize = (e) => { e.stopPropagation(); isResizing = true; startX = e.clientX; startY = e.clientY; startW = buildings[selectedIdx].w; startH = buildings[selectedIdx].h; };
        window.startRotate = (e) => {
            e.stopPropagation(); isRotating = true;
            const r = document.getElementById('map-root').getBoundingClientRect();
            const b = buildings[selectedIdx];
            centerX = (b.x + b.w/2) * r.width / 100 + r.left;
            centerY = (b.y + b.h/2) * r.height / 100 + r.top;
            startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI - (b.angle || 0);
        };

        window.onmousemove = (e) => {
            if (selectedIdx === -1 || !editMode) return;
            const b = buildings[selectedIdx];
            const r = document.getElementById('map-root').getBoundingClientRect();
            if (isDragging) {
                b.x += ((e.clientX - startX) / r.width) * 100;
                b.y += ((e.clientY - startY) / r.height) * 100;
                startX = e.clientX; startY = e.clientY;
            } else if (isResizing) {
                b.w = Math.max(2, startW + ((e.clientX - startX) / r.width) * 100);
                b.h = Math.max(2, startH + ((e.clientY - startY) / r.height) * 100);
            } else if (isRotating) {
                b.angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI - startAngle;
            }
            if (isDragging || isResizing || isRotating) { updateTransformer(); renderShapes(); }
        };

        window.onmouseup = () => { isDragging = isResizing = isRotating = false; };

        function updateTransformer() {
            const tf = document.getElementById('transformer');
            if (selectedIdx === -1) { tf.classList.add('hidden'); return; }
            const b = buildings[selectedIdx];
            tf.classList.remove('hidden');
            tf.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg);`;
        }

        function renderShapes() {
            const layer = document.getElementById('shapes-layer');
            layer.style.opacity = editMode ? "1" : "0.5"; // ç·¨è¼¯æ¨¡å¼æ™‚é¡¯ç¤ºåŠé€æ˜æ¡†
            layer.innerHTML = buildings.map((b, i) => {
                const isSelected = (i === selectedIdx);
                const isTri = (b.name === "ç’°å¢ƒæ¨“");
                const style = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg); border:${isSelected ? '3px solid #6366f1' : '1px solid red'}; background:rgba(99,102,241,0.2);`;
                return `<div class="building-shape ${isTri ? 'is-triangle' : ''}" style="${style}"></div>`;
            }).join('');
        }

        window.saveToFirebase = async () => {
            await updateDoc(CAMPUS_DOC, { buildings });
            alert("âœ… åœ°åœ–ä¸‰è§’å½¢å·²æ–°å¢ä¸¦æˆåŠŸå„²å­˜è‡³é›²ç«¯ï¼");
        };

        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
    </script>
</body>
</html>
