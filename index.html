<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç’°å¢ƒæ¨“å®šä½ä¿®æ­£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; }
        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2rem; border: 4px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: visible; /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒè¢«åˆ‡æ‰ */
        }
        #shapes-layer { position: absolute; inset: 0; pointer-events: none; z-index: 100; }
        .building-shape { 
            position: absolute; 
            transform-origin: center; 
            pointer-events: auto; /* ç¢ºä¿åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹å¯é»æ“Š */
            cursor: move;
        }
        /* ç›´è§’ä¸‰è§’å½¢ */
        .s-triangle { 
            clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
            -webkit-clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
        }
        /* å¼·åŒ–çš„æ§åˆ¶åˆ— */
        .edit-controls { 
            position: absolute; 
            bottom: -60px; /* æ”¹åˆ°ä¸‹æ–¹é¿å…è¢«æ“‹ä½ */
            left: 50%; 
            transform: translateX(-50%); 
            background: #1e293b; /* æ·±è‰²èƒŒæ™¯æ›´æ˜é¡¯ */
            padding: 8px; 
            border-radius: 12px; 
            display: flex; 
            gap: 6px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
            z-index: 9999; 
            white-space: nowrap;
        }
        .edit-btn { 
            padding: 5px 10px; 
            background: #334155; 
            color: white; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: bold; 
            border: 1px solid #475569;
        }
        .edit-btn:active { background: #4f46e5; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-5xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800">ğŸ›  ç’°å¢ƒæ¨“ç²¾ç¢ºå®šä½å·¥å…·</h1>
            <p id="mode-status" class="text-indigo-600 font-bold mt-2">è«‹é€£é»åœ°åœ– 3 ä¸‹é€²å…¥ç·¨è¼¯æ¨¡å¼</p>
        </div>

        <div id="map-root" class="map-container" onclick="handleMapClick(event)">
            <div id="shapes-layer"></div>
        </div>
        
        <div class="mt-20 p-6 bg-white rounded-2xl shadow-sm border border-slate-200">
            <h3 class="font-bold text-slate-700 mb-2">ä½¿ç”¨èªªæ˜ï¼š</h3>
            <ul class="text-sm text-slate-500 list-disc ml-5 space-y-1">
                <li>é€£é»ä¸‰ä¸‹é€²å…¥æ¨¡å¼å¾Œï¼Œåœ°åœ–æœƒè®Šæš—ã€‚</li>
                <li>é»æ“Šç’°å¢ƒæ¨“ä½ç½®å¯æ–°å¢ä¸‰è§’å½¢ï¼Œé»æ“Š<strong>ä¸‰è§’å½¢æœ¬èº«</strong>æ‰æœƒå‡ºç¾æ§åˆ¶åˆ—ã€‚</li>
                <li>èª¿æ•´å®Œç•¢è«‹å‹™å¿…é»æ“Šç¶ è‰²çš„ <b>[ğŸ’¾ å­˜æª”]</b> æŒ‰éˆ•ã€‚</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let buildings = [], editMode = false, selectedIdx = -1;

        // åµæ¸¬æ˜¯å¦é»æ“Šåœ¨å½¢ç‹€å…§
        function isPointInShape(px, py, box) {
            const angleRad = (box.angle || 0) * Math.PI / 180;
            const cx = box.x + box.w / 2, cy = box.y + box.h / 2;
            const dx = px - cx, dy = py - cy;
            const rx = dx * Math.cos(-angleRad) - dy * Math.sin(-angleRad);
            const ry = dx * Math.sin(-angleRad) + dy * Math.cos(-angleRad);
            const x1 = -box.w/2, y1 = -box.h/2, x2 = -box.w/2, y2 = box.h/2, x3 = box.w/2, y3 = box.h/2;
            const getArea = (xa, ya, xb, yb, xc, yc) => Math.abs((xa*(yb-yc) + xb*(yc-ya) + xc*(ya-yb))/2.0);
            const area = getArea(x1,y1,x2,y2,x3,y3);
            const a1 = getArea(rx,ry,x1,y1,x2,y2), a2 = getArea(rx,ry,x2,y2,x3,y3), a3 = getArea(rx,ry,x3,y3,x1,y1);
            return Math.abs(area - (a1 + a2 + a3)) < 2.0;
        }

        window.addEventListener('click', (e) => {
            if (e.detail === 3) {
                editMode = !editMode;
                document.getElementById('mode-status').innerText = editMode ? "âš ï¸ ç·¨è¼¯æ¨¡å¼ï¼šè«‹é»æ“Šå»ºç¯‰ç‰©é€²è¡Œèª¿æ•´" : "å·²é›¢é–‹ç·¨è¼¯æ¨¡å¼";
                renderShapes();
            }
        });

        window.handleMapClick = (e) => {
            if (!editMode) return;
            const r = document.getElementById('map-root').getBoundingClientRect();
            const clickX = ((e.clientX-r.left)/r.width)*100;
            const clickY = ((e.clientY-r.top)/r.height)*100;

            const hitIndex = buildings.findIndex(b => isPointInShape(clickX, clickY, b));
            
            if (hitIndex !== -1) {
                selectedIdx = hitIndex;
                renderShapes();
            } else {
                if(confirm("è¦åœ¨é€™è£¡æ–°å¢ç’°å¢ƒæ¨“å—ï¼Ÿ")) {
                    buildings.push({ name: "ç’°å¢ƒæ¨“", type: 'triangle', x: clickX-5, y: clickY-5, w: 10, h: 10, angle: 0 });
                    selectedIdx = buildings.length - 1;
                    renderShapes();
                }
            }
        };

        window.adjust = (prop, val) => {
            if (selectedIdx === -1) return;
            buildings[selectedIdx][prop] = Math.round((buildings[selectedIdx][prop] + val) * 10) / 10;
            renderShapes();
        };

        window.saveData = async () => {
            await updateDoc(CAMPUS_DOC, { buildings: buildings });
            alert("å­˜æª”æˆåŠŸï¼");
        };

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach((b, i) => {
                const el = document.createElement('div');
                el.className = `building-shape s-${b.type}`;
                const isSelected = (i === selectedIdx && editMode);
                const style = isSelected ? 
                    `border: 3px solid #6366f1; background: rgba(99,102,241,0.4);` : 
                    (editMode ? `border: 1px solid red; background: rgba(255,0,0,0.1);` : `background: transparent;`);
                
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle||0}deg); ${style}`;
                
                if (isSelected) {
                    const ctrl = document.createElement('div');
                    ctrl.className = "edit-controls";
                    ctrl.innerHTML = `
                        <button class="edit-btn" onclick="event.stopPropagation();adjust('x',-0.5)">å·¦</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust('x',0.5)">å³</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust('w',1)">å¯¬+</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust('h',1)">é«˜+</button>
                        <button class="edit-btn text-yellow-400" onclick="event.stopPropagation();adjust('angle',5)">ğŸ”„ æ—‹è½‰</button>
                        <button class="edit-btn text-green-400" onclick="event.stopPropagation();saveData()">ğŸ’¾ å­˜æª”</button>
                    `;
                    el.appendChild(ctrl);
                }
                layer.appendChild(el);
            });
        }

        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
    </script>
</body>
</html>
