<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU äº’åŠ©æœƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; overflow-x: hidden; }
        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: visible; cursor: crosshair; touch-action: none;
        }
        #shapes-layer, #pins-layer { position: absolute; inset: 0; pointer-events: none; }
        #shapes-layer { z-index: 80; }
        #pins-layer { z-index: 90; }
        
        /* ä¸‰è§’å½¢åŸºç¤ */
        .building-shape { 
            position: absolute; transform-origin: center; pointer-events: auto; 
            clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
            -webkit-clip-path: polygon(0% 0%, 0% 100%, 100% 100%);
        }

        /* ç·¨è¼¯æ§åˆ¶é … */
        .transformer { position: absolute; border: 2px dashed #6366f1; pointer-events: none; z-index: 1000; transform-origin: center; }
        .handle { 
            position: absolute; width: 14px; height: 14px; background: white; 
            border: 2px solid #6366f1; border-radius: 50%; pointer-events: auto; cursor: nwse-resize; 
        }
        .rotate-handle { 
            top: -30px; left: 50%; transform: translateX(-50%); background: #6366f1; cursor: grab;
        }
        .rotate-handle:active { cursor: grabbing; }
        .resize-handle { bottom: -7px; right: -7px; }
        
        .save-btn-float {
            position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%);
            background: #10b981; color: white; padding: 8px 20px; border-radius: 99px;
            font-weight: bold; font-size: 14px; cursor: pointer; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .floating-pin { position: absolute; transform: translate(-50%, -50%); cursor: pointer; pointer-events: auto; z-index: 100; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0.4); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0); transform: scale(1); }
        }
        .tab-active { background-color: #4f46e5 !important; color: white !important; }
        .tab-lost-active { background-color: #ef4444 !important; color: white !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ğŸ’ NTCU ä¸€ä¸Ÿä¸€æ’¿</h1>
                <p id="mode-desc" class="text-slate-500 text-sm">é»æ“Šåœ°åœ–æ¨™è¨»ï¼š<span class="text-indigo-600 font-bold">è—è‰²æ‹¾ç²</span> / <span class="text-red-500 font-bold">ç´…è‰²éºå¤±</span></p>
            </div>
            <div class="bg-white p-3 px-6 rounded-3xl shadow-sm border border-slate-100 text-right">
                <span class="text-[9px] font-black text-slate-400 block">TOP HERO</span>
                <span id="top-hero-name" class="text-xl font-black text-indigo-600">è¼‰å…¥ä¸­...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                <div id="map-root" class="map-container" onmousedown="handleMouseDown(event)">
                    <div id="shapes-layer"></div>
                    <div id="pins-layer"></div>
                    <div id="transformer" class="transformer hidden">
                        <div class="handle rotate-handle" onmousedown="startRotate(event)"></div>
                        <div class="handle resize-handle" onmousedown="startResize(event)"></div>
                        <div class="save-btn-float" onclick="saveB()">å„²å­˜åœ°åœ–é…ç½® ğŸ’¾</div>
                    </div>
                </div>
                <p id="edit-hint" class="hidden mt-4 text-indigo-600 font-bold text-center text-sm">ğŸ›  ç·¨è¼¯æ¨¡å¼ï¼šé»æ“Šä¸‰è§’å½¢å¯ã€Œæ‹–æ›³ç§»å‹•ã€ã€ã€Œåœ“é»ç¸®æ”¾ã€æˆ–ã€Œä¸Šæ–¹è—é»æ—‹è½‰ã€</p>
            </div>
            <div class="lg:col-span-4 flex flex-col gap-6">
                <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl">
                    <h3 class="font-bold mb-4 text-sm">ğŸ† åŠŸå¾·æ¦œ</h3>
                    <div id="leaderboard" class="space-y-3 text-xs"></div>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-sm border h-[400px] flex flex-col overflow-hidden">
                    <div class="p-5 border-b bg-slate-50 font-black text-slate-600 text-sm flex justify-between">
                        <span>æœ€æ–°å‹•æ…‹</span>
                        <span id="items-count" class="text-indigo-500 font-bold">0</span>
                    </div>
                    <div id="items-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-[300] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full p-6 shadow-2xl text-center">
            <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                <button onclick="switchTab('found')" id="tab-found" class="flex-1 py-2 rounded-xl font-black text-sm tab-active">æ’¿åˆ°æ±è¥¿</button>
                <button onclick="switchTab('lost')" id="tab-lost" class="flex-1 py-2 rounded-xl font-black text-sm text-slate-400">éºå¤±ç‰©å“</button>
            </div>
            <div class="mb-5"><div id="location-name" class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 text-base font-black rounded-2xl">å®šä½ä¸­...</div></div>
            <div class="space-y-3 mb-6 text-left">
                <input type="text" id="in-nick" placeholder="æš±ç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="in-item" placeholder="ç‰©å“åç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="in-floor" placeholder="å…·é«”ä½ç½® (ä¾‹ï¼šA302ã€çƒå ´)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="in-desc" placeholder="è©³ç´°æè¿° (é¡è‰²ç‰¹å¾µã€å¤–è§€)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <div class="p-3 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer text-center" onclick="document.getElementById('in-file').click()">
                    <input type="file" id="in-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <div id="preview-container" class="hidden"><img id="img-preview" src="" class="rounded-xl mx-auto max-h-24 object-cover"></div>
                    <div id="upload-placeholder" class="text-slate-400 text-[10px]">ğŸ“· æ‹ç…§ä¸Šå‚³ (é¸å¡«)</div>
                </div>
            </div>
            <button id="submit-btn" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg transition">ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)</button>
            <button onclick="closeModals()" class="mt-4 text-slate-400 font-bold text-xs">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[400] p-4 backdrop-blur-md">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div id="detail-header-color" class="w-full bg-slate-100 flex items-center justify-center relative min-h-[150px]">
                <img id="detail-img" src="" class="w-full h-auto max-h-[50vh] object-contain block">
                <div id="no-img-placeholder" class="hidden text-slate-300 font-bold text-sm py-20">ğŸ“· ç„¡ç…§ç‰‡é è¦½</div>
                <div id="type-tag" class="absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white z-10 shadow-md"></div>
            </div>
            <div class="p-6 overflow-y-auto text-left">
                <h2 id="detail-name" class="text-2xl font-black text-slate-800 line-clamp-1">ç‰©å“åç¨±</h2>
                <p id="detail-loc" class="text-slate-400 font-bold text-sm mb-4 truncate"></p>
                <div class="space-y-3 mb-6">
                    <div class="bg-slate-50 rounded-xl p-3 border-l-4 border-indigo-500">
                        <p class="text-[9px] text-slate-400 font-black">å…·é«”ä½ç½®</p>
                        <p id="detail-floor" class="font-bold text-sm text-slate-700"></p>
                    </div>
                    <div class="bg-amber-50 rounded-xl p-3 border-l-4 border-amber-400">
                        <p class="text-[9px] text-amber-500 font-black">è©³ç´°æè¿°</p>
                        <p id="detail-desc" class="font-bold text-sm text-slate-700"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-claim-now" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl">æ˜¯æˆ‘çš„ï¼</button>
                    <button onclick="closeDetail()" class="px-6 py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LOST_COLL = collection(db, "all_reports_v3");
        const USER_COLL = collection(db, "users_v2");
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let currentTab = 'found', buildings = [], reports = [], editMode = false, selectedIdx = -1;
        let isDragging = false, isResizing = false, isRotating = false;
        let startX, startY, startW, startH, startAngle, centerX, centerY;

        // ä¸‰è§’å½¢åˆ¤å®š
        function isPointInTriangle(px, py, b) {
            const rad = (b.angle || 0) * Math.PI / 180;
            const cx = b.x + b.w/2, cy = b.y + b.h/2;
            const dx = px - cx, dy = py - cy;
            const rx = dx * Math.cos(-rad) - dy * Math.sin(-rad);
            const ry = dx * Math.sin(-rad) + dy * Math.cos(-rad);
            const x1 = -b.w/2, y1 = -b.h/2, x2 = -b.w/2, y2 = b.h/2, x3 = b.w/2, y3 = b.h/2;
            const getArea = (xa,ya,xb,yb,xc,yc) => Math.abs((xa*(yb-yc)+xb*(yc-ya)+xc*(ya-yb))/2);
            const total = getArea(x1,y1,x2,y2,x3,y3);
            const a1 = getArea(rx,ry,x1,y1,x2,y2), a2 = getArea(rx,ry,x2,y2,x3,y3), a3 = getArea(rx,ry,x3,y3,x1,y1);
            return Math.abs(total - (a1+a2+a3)) < 1.0;
        }

        // é»æ“Šè™•ç†
        window.handleMouseDown = (e) => {
            const r = document.getElementById('map-root').getBoundingClientRect();
            const px = ((e.clientX-r.left)/r.width)*100;
            const py = ((e.clientY-r.top)/r.height)*100;
            const hitIdx = buildings.findIndex(b => isPointInTriangle(px, py, b));

            if (editMode) {
                if (hitIdx !== -1) {
                    selectedIdx = hitIdx;
                    isDragging = true;
                    startX = e.clientX; startY = e.clientY;
                    updateTransformer();
                } else {
                    selectedIdx = -1;
                    updateTransformer();
                    // æ–°å¢
                    if(confirm("åœ¨æ­¤è™•æ–°å¢ç’°å¢ƒæ¨“ï¼Ÿ")) {
                        buildings.push({ name: "ç’°å¢ƒæ¨“", x: px-5, y: py-5, w: 10, h: 10, angle: 0 });
                        selectedIdx = buildings.length - 1;
                        updateTransformer();
                        renderShapes();
                    }
                }
            } else {
                const clickPos = { x: px, y: py };
                document.getElementById('location-name').innerText = `ğŸ“ ${hitIdx!==-1?buildings[hitIdx].name:"æ ¡åœ’é–‹æ”¾å€åŸŸ"}`;
                window.lastClickPos = clickPos;
                document.getElementById('report-modal').classList.remove('hidden');
            }
        };

        // ç¸®æ”¾èˆ‡æ—‹è½‰é‚è¼¯
        window.startResize = (e) => { e.stopPropagation(); isResizing = true; startX = e.clientX; startY = e.clientY; startW = buildings[selectedIdx].w; startH = buildings[selectedIdx].h; };
        window.startRotate = (e) => { 
            e.stopPropagation(); isRotating = true;
            const r = document.getElementById('map-root').getBoundingClientRect();
            const b = buildings[selectedIdx];
            centerX = (b.x + b.w/2) * r.width / 100 + r.left;
            centerY = (b.y + b.h/2) * r.height / 100 + r.top;
            startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI - (b.angle || 0);
        };

        window.onmousemove = (e) => {
            if (selectedIdx === -1) return;
            const b = buildings[selectedIdx];
            const r = document.getElementById('map-root').getBoundingClientRect();

            if (isDragging) {
                b.x += ((e.clientX - startX) / r.width) * 100;
                b.y += ((e.clientY - startY) / r.height) * 100;
                startX = e.clientX; startY = e.clientY;
            } else if (isResizing) {
                b.w = Math.max(2, startW + ((e.clientX - startX) / r.width) * 100);
                b.h = Math.max(2, startH + ((e.clientY - startY) / r.height) * 100);
            } else if (isRotating) {
                const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
                b.angle = currentAngle - startAngle;
            }

            if (isDragging || isResizing || isRotating) {
                updateTransformer();
                renderShapes();
            }
        };

        window.onmouseup = () => { isDragging = isResizing = isRotating = false; };

        function updateTransformer() {
            const tf = document.getElementById('transformer');
            if (selectedIdx === -1 || !editMode) { tf.classList.add('hidden'); return; }
            const b = buildings[selectedIdx];
            tf.classList.remove('hidden');
            tf.style.left = `${b.x}%`; tf.style.top = `${b.y}%`;
            tf.style.width = `${b.w}%`; tf.style.height = `${b.h}%`;
            tf.style.transform = `rotate(${b.angle || 0}deg)`;
        }

        // é€£é»ä¸‰ä¸‹
        window.addEventListener('click', (e) => {
            if (e.detail === 3) {
                editMode = !editMode;
                document.getElementById('edit-hint').classList.toggle('hidden');
                document.getElementById('mode-desc').innerText = editMode ? "ğŸ›  ç·¨è¼¯æ¨¡å¼ (æ‹–æ›³/ç¸®æ”¾/æ—‹è½‰)" : "é»æ“Šåœ°åœ–æ¨™è¨»ï¼šè—è‰²æ‹¾ç² / ç´…è‰²éºå¤±";
                selectedIdx = -1; updateTransformer(); renderShapes();
            }
        });

        // Firebase é‚è¼¯å¾©åŸ
        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
        onSnapshot(LOST_COLL, (s) => { 
            reports = s.docs.map(d => ({ id: d.id, ...d.data() })); 
            document.getElementById('items-count').innerText = reports.length;
            renderPins(); renderList(); 
        });
        onSnapshot(query(USER_COLL, orderBy("merit", "desc"), limit(5)), (s) => {
            document.getElementById('leaderboard').innerHTML = s.docs.map((d, i) => `
                <div class="flex justify-between items-center p-2 bg-white/10 rounded-xl text-[11px]">
                    <span>${i+1}. ${d.id}</span><b>${d.data().merit || 0} pts</b>
                </div>`).join('');
            if(s.docs[0]) document.getElementById('top-hero-name').innerText = s.docs[0].id;
        });

        window.saveB = async () => { await updateDoc(CAMPUS_DOC, { buildings }); alert("âœ… å·²å­˜æª”ï¼"); };

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach((b, i) => {
                const el = document.createElement('div');
                el.className = 'building-shape';
                const visual = editMode ? `border: 1px solid rgba(255,0,0,0.5); background: rgba(255,0,0,0.1);` : 'background: transparent;';
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle||0}deg); ${visual}`;
                layer.appendChild(el);
            });
        }

        // --- UI æ“ä½œå¾©åŸ ---
        window.switchTab = (t) => {
            currentTab = t;
            document.getElementById('tab-found').className = t==='found' ? "flex-1 py-2 rounded-xl font-black text-sm tab-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            document.getElementById('tab-lost').className = t==='lost' ? "flex-1 py-2 rounded-xl font-black text-sm tab-lost-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            document.getElementById('submit-btn').innerText = t === 'found' ? "ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)" : "ç™¼å¸ƒæ±‚åŠ©æ¨™è¨˜";
            document.getElementById('submit-btn').className = `w-full py-4 text-white font-black rounded-2xl shadow-lg transition ${t==='found'?'bg-indigo-600':'bg-red-500'}`;
        };

        document.getElementById('submit-btn').onclick = async () => {
            const nick = document.getElementById('in-nick').value.trim(), item = document.getElementById('in-item').value.trim();
            if(!nick || !item) return alert("å¿…å¡«ï¼");
            await setDoc(doc(LOST_COLL), { 
                type: currentTab, name: item, finder: nick, 
                floor_info: document.getElementById('in-floor').value, description: document.getElementById('in-desc').value,
                location: document.getElementById('location-name').innerText.replace('ğŸ“ ',''),
                imageUrl: document.getElementById('img-preview').src.startsWith('data:image') ? document.getElementById('img-preview').src : "",
                x: window.lastClickPos.x, y: window.lastClickPos.y, time: Date.now() 
            });
            if(currentTab === 'found') await updateDoc(doc(USER_COLL, nick), { merit: increment(50) }).catch(async () => { await setDoc(doc(USER_COLL, nick), { merit: 50 }); });
            closeModals();
        };

        function renderPins() {
            const layer = document.getElementById('pins-layer'); layer.innerHTML = '';
            reports.forEach(i => {
                const p = document.createElement('div'); p.className = 'floating-pin';
                p.style.left = `${i.x}%`; p.style.top = `${i.y}%`;
                p.innerHTML = `<div class="pin-dot ${i.type === 'found' ? 'bg-indigo-600' : 'bg-red-500'}"></div>`;
                p.onclick = (e) => { e.stopPropagation(); openDetail(i.id); };
                layer.appendChild(p);
            });
        }

        function renderList() {
            document.getElementById('items-list').innerHTML = reports.sort((a,b)=>b.time-a.time).map(i => `
                <div onclick="openDetail('${i.id}')" class="p-3 bg-white rounded-2xl border-l-4 ${i.type==='found'?'border-indigo-500':'border-red-500'} flex items-center gap-3 cursor-pointer shadow-sm">
                    <div class="w-10 h-10 bg-slate-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-full object-cover">` : 'ğŸ'}
                    </div>
                    <div class="flex-1 truncate text-left text-slate-700 font-bold text-sm">${i.name}<div class="text-[9px] text-slate-400 italic">${i.location}</div></div>
                </div>`).join('');
        }

        window.openDetail = (id) => {
            const item = reports.find(i => i.id === id); if(!item) return;
            document.getElementById('type-tag').innerText = item.type === 'found' ? 'æ‹¾ç²ç‰©' : 'å”å°‹ä¸­';
            document.getElementById('type-tag').className = `absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white z-10 ${item.type==='found'?'bg-indigo-600':'bg-red-500'}`;
            document.getElementById('detail-name').innerText = item.name;
            document.getElementById('detail-loc').innerText = `ğŸ“ ${item.location}`;
            document.getElementById('detail-floor').innerText = item.floor_info || "å°šæœªæä¾›å…·é«”ä½ç½®";
            document.getElementById('detail-desc').innerText = item.description || "ç„¡é¡å¤–æè¿°å…§å®¹";
            const img = document.getElementById('detail-img'), ph = document.getElementById('no-img-placeholder');
            if(item.imageUrl) { img.src = item.imageUrl; img.classList.remove('hidden'); ph.classList.add('hidden'); }
            else { img.classList.add('hidden'); ph.classList.remove('hidden'); }
            document.getElementById('btn-claim-now').onclick = async () => { if(confirm('é ˜å›ï¼Ÿ')){ await deleteDoc(doc(db, "all_reports_v3", id)); closeDetail(); } };
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        window.previewImage = (input) => {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = e => { 
                document.getElementById('img-preview').src = e.target.result; 
                document.getElementById('preview-container').classList.remove('hidden'); 
                document.getElementById('upload-placeholder').classList.add('hidden'); 
            };
            r.readAsDataURL(f);
        };
        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
        window.closeDetail = () => document.getElementById('detail-modal').classList.add('hidden');
    </script>
</body>
</html>
