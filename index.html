<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU å¯¦å¢ƒåŠŸå¾·åœ°åœ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }

        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; cursor: crosshair;
        }

        /* å»ºç¯‰å½¢ç‹€æ¨£å¼ */
        .building-shape { position: absolute; transform-origin: center center; }
        .s-capsule { border-radius: 999px !important; background: rgba(79, 70, 229, 0.1); }
        .s-rect { border-radius: 4px; background: rgba(79, 70, 229, 0.1); }
        .selected-shape { border: 2px solid #4f46e5 !important; z-index: 50; background: rgba(79, 70, 229, 0.2); }

        /* æ§åˆ¶æŠŠæ‰‹ */
        .handle { position: absolute; width: 10px; height: 10px; background: #fff; border: 2px solid #4f46e5; border-radius: 50%; z-index: 60; }
        .rotate-handle { position: absolute; width: 14px; height: 14px; background: #4f46e5; border: 2px solid #fff; border-radius: 50%; top: -30px; left: 50%; transform: translateX(-50%); cursor: grab; }
        .rotate-line { position: absolute; width: 2px; height: 20px; background: #4f46e5; top: -20px; left: 50%; transform: translateX(-50%); }

        .tool-btn { @apply px-3 py-2 bg-slate-800 rounded-xl text-[12px] text-white hover:bg-indigo-600 transition-all; }
        @keyframes float { 0%, 100% { transform: translate(-50%, -100%) translateY(0px); } 50% { transform: translate(-50%, -100%) translateY(-10px); } }
        .floating-pin { animation: float 2s ease-in-out infinite; position: absolute; pointer-events: none; }
    </style>
</head>
<body class="p-4 md:p-8 bg-slate-50">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
            <div>
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg"><span class="text-2xl">ğŸ’</span></div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight">NTCU å¯¦å¢ƒåŠŸå¾·åœ°åœ– <button id="admin-trigger" class="opacity-0">âš™ï¸</button></h1>
                </div>
                <p class="text-slate-500 mt-2 font-medium">æ¨™è¨»ä½ç½®ï¼Œç´¯ç©åŠŸå¾·ã€‚</p>
            </div>
            <div class="flex items-center gap-4 bg-white p-2 px-6 rounded-3xl shadow-sm border border-slate-100">
                <div class="text-right"><span class="text-[10px] text-slate-400 font-black block">å€‹äººåŠŸå¾·</span><span id="display-nickname" class="text-base font-bold text-slate-700">è¨ªå®¢</span></div>
                <div class="h-8 w-px bg-slate-100 mx-2"></div>
                <div class="text-right"><span class="text-[10px] text-slate-400 font-black block">ç´¯ç©é»æ•¸</span><span id="my-merit" class="text-xl font-black text-indigo-600">0</span></div>
            </div>
        </header>

        <div id="admin-tools" class="hidden mb-6 p-4 bg-slate-900 text-white rounded-3xl shadow-2xl flex flex-wrap items-center justify-between gap-4">
            <div class="flex gap-2">
                <button onclick="setTool('rect')" class="tool-btn">ï¼‹ çŸ©å½¢</button>
                <button onclick="setTool('capsule')" class="tool-btn bg-purple-600">ï¼‹ è† å›Š</button>
                <button onclick="deleteSelected()" class="tool-btn bg-red-500/50">åˆªé™¤é¸ä¸­</button>
            </div>
            <button onclick="toggleAdmin(false)" class="bg-slate-700 px-4 py-1.5 rounded-xl text-xs font-bold">é€€å‡ºç®¡ç†</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                <div id="map-root" class="map-container">
                    <div id="shapes-layer" class="absolute inset-0"></div>
                    <div id="pins-layer" class="absolute inset-0"></div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-6">
                <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl">
                    <h3 class="text-lg font-bold mb-4">ğŸ† åŠŸå¾·æ’è¡Œæ¦œ</h3>
                    <div id="leaderboard" class="space-y-3 text-sm"></div>
                </div>

                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 h-[400px] flex flex-col overflow-hidden">
                    <div class="p-6 border-b bg-slate-50 font-black text-slate-700 flex justify-between items-center">
                        <span>ğŸ” å¾…èªé ˜ç‰©å“</span>
                        <span id="items-count" class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-xs">0</span>
                    </div>
                    <div id="items-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white rounded-[2.5rem] max-w-md w-full p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-1">ğŸ“ ç™¼ç¾éºå¤±ç‰©</h3>
            <div id="location-name" class="inline-block bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1.5 rounded-full mb-6 italic">å®šä½ä¸­...</div>
            <div class="space-y-4">
                <input type="text" id="in-nick" placeholder="æ‚¨çš„æš±ç¨±" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:border-indigo-500">
                <input type="text" id="in-item" placeholder="ç‰©å“åç¨±" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none focus:border-indigo-500">
                <button id="btn-submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg">é€å‡ºå ±å¤± (+50)</button>
                <button onclick="closeModals()" class="w-full text-slate-400 font-bold py-2 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLL = "campus_data", DOC = "NTCU-CAMPUS-V2";

        let buildings = [], lostItems = [], selectedId = null, isAdmin = false;
        let isDragging = false, isRotating = false, isResizing = false;
        let currentHandle = null, startPos = { x:0, y:0 }, adminClicks = 0;
        let clickPos = { x:50, y:50 };

        // ç›£è½å»ºç¯‰èˆ‡ç‰©å“
        onSnapshot(doc(db, COLL, DOC), (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
        onSnapshot(collection(db, "lost_items_v1"), (s) => {
            lostItems = s.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('items-count').innerText = lostItems.length;
            renderPins(); renderList();
        });
        onSnapshot(collection(db, "users_v1"), (s) => {
            const list = s.docs.map(d => ({ name: d.id, merit: d.data().merit || 0 })).sort((a,b)=>b.merit-a.merit);
            document.getElementById('leaderboard').innerHTML = list.slice(0, 5).map((u, i) => `<div class="flex justify-between"><span>${i+1}. ${u.name}</span><span>${u.merit} pts</span></div>`).join('');
        });

        // åˆ¤å®šå‡½æ•¸
        function isPointInShape(px, py, box) {
            const rad = -box.angle * Math.PI / 180;
            const cx = box.x + box.w / 2, cy = box.y + box.h / 2;
            const rx = (px-cx)*Math.cos(rad)-(py-cy)*Math.sin(rad), ry = (px-cx)*Math.sin(rad)+(py-cy)*Math.cos(rad);
            if (box.type === 'capsule') {
                const r = (box.w>=box.h)?box.h/2:box.w/2, len = (box.w>=box.h)?box.w-box.h:box.h-box.w;
                const dist = (box.w>=box.h)?Math.sqrt(Math.pow(rx-Math.max(-len/2,Math.min(len/2,rx)),2)+Math.pow(ry,2)):Math.sqrt(Math.pow(rx,2)+Math.pow(ry-Math.max(-len/2,Math.min(len/2,ry)),2));
                return dist <= r;
            }
            return Math.abs(rx) <= box.w/2 && Math.abs(ry) <= box.h/2;
        }

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach((b, i) => {
                const el = document.createElement('div');
                el.className = `building-shape ${selectedId === i ? 'selected-shape' : ''} s-${b.type}`;
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg);`;
                if (isAdmin && selectedId === i) {
                    el.innerHTML = `<div class="rotate-line"></div><div class="rotate-handle" onmousedown="window.startRotate(event)"></div><div class="handle" style="top:-5px;left:-5px;cursor:nw-resize" onmousedown="window.startResize(event,'nw')"></div><div class="handle" style="bottom:-5px;right:-5px;cursor:se-resize" onmousedown="window.startResize(event,'se')"></div>`;
                }
                el.onmousedown = (e) => {
                    e.stopPropagation();
                    if (isAdmin) { selectedId = i; isDragging = true; startPos = getMousePos(e); renderShapes(); }
                    else { handleMapClick(e); }
                };
                layer.appendChild(el);
            });
        }

        function renderPins() {
            const layer = document.getElementById('pins-layer'); layer.innerHTML = '';
            lostItems.forEach(item => {
                const p = document.createElement('div');
                p.className = 'floating-pin'; p.style.left = `${item.x}%`; p.style.top = `${item.y}%`;
                p.innerHTML = `<div class="bg-indigo-600 text-white text-[9px] px-2 py-1 rounded shadow-lg mb-1 font-bold">${item.name}</div><div class="w-3 h-3 bg-white rounded-full border-2 border-indigo-600 mx-auto"></div>`;
                layer.appendChild(p);
            });
        }

        function renderList() {
            document.getElementById('items-list').innerHTML = lostItems.map(item => `
                <div class="p-4 bg-white rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm">
                    <div><div class="font-bold text-slate-800 text-sm">${item.name}</div><div class="text-[10px] text-indigo-500 font-black">ğŸ“ ${item.location}</div></div>
                    <button onclick="window.claimItem('${item.id}','${item.finder}')" class="bg-emerald-500 text-white text-[10px] px-3 py-1 rounded-lg font-bold">èªé ˜</button>
                </div>`).join('') || '<div class="text-center py-12 text-slate-300 text-sm">ç›®å‰æ²’æœ‰éºå¤±ç‰©</div>';
        }

        window.claimItem = async (id, f) => { if(confirm("ç¢ºèªé ˜å–ï¼Ÿ")) { await deleteDoc(doc(db, "lost_items_v1", id)); await setDoc(doc(db, "users_v1", f), { merit: increment(20) }, { merge: true }); } };

        function handleMapClick(e) {
            clickPos = getMousePos(e);
            let hit = -1;
            for (let i = buildings.length-1; i>=0; i--) { if(isPointInShape(clickPos.x, clickPos.y, buildings[i])) { hit = i; break; } }
            document.getElementById('location-name').innerText = `ğŸ“ ${hit !== -1 ? buildings[hit].name : "æ ¡åœ’é–‹æ”¾å€åŸŸ"}`;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        document.getElementById('map-root').onmousedown = (e) => { if(e.target.id === 'map-root' || e.target.id === 'shapes-layer') { if(isAdmin) { selectedId = null; renderShapes(); } else { handleMapClick(e); } } };

        window.addEventListener('mousemove', (e) => {
            if (!isAdmin || selectedId === null) return;
            const cur = getMousePos(e), b = buildings[selectedId];
            if (isDragging) { b.x += (cur.x - startPos.x); b.y += (cur.y - startPos.y); }
            else if (isRotating) { const cx = b.x + b.w/2, cy = b.y + b.h/2; b.angle = Math.atan2(cur.y - cy, cur.x - cx) * 180 / Math.PI + 90; }
            else if (isResizing) { if (currentHandle === 'se') { b.w += (cur.x - (b.x + b.w)); b.h += (cur.y - (b.y + b.h)); } else { const dx = cur.x - b.x, dy = cur.y - b.y; b.x += dx; b.y += dy; b.w -= dx; b.h -= dy; } }
            if (isDragging || isRotating || isResizing) { startPos = cur; renderShapes(); }
        });

        window.addEventListener('mouseup', async () => { if (isDragging || isRotating || isResizing) { await setDoc(doc(db, COLL, DOC), { buildings }); isDragging = isRotating = isResizing = false; } });

        window.startRotate = (e) => { e.stopPropagation(); isRotating = true; };
        window.startResize = (e, h) => { e.stopPropagation(); isResizing = true; currentHandle = h; };
        window.setTool = async (type) => { const name = prompt("å€åŸŸåç¨±ï¼š"); if(name) { buildings.push({ x:40, y:40, w:15, h:8, angle:0, name, type }); await setDoc(doc(db, COLL, DOC), { buildings }); } };
        window.deleteSelected = async () => { if(selectedId !== null) { buildings.splice(selectedId, 1); selectedId = null; await setDoc(doc(db, COLL, DOC), { buildings }); } };
        window.toggleAdmin = (s) => { isAdmin = s; document.getElementById('admin-tools').classList.toggle('hidden', !s); selectedId = null; renderShapes(); };
        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
        document.getElementById('admin-trigger').onclick = () => { adminClicks++; if(adminClicks >= 5) toggleAdmin(true); };
        document.getElementById('btn-submit').onclick = async () => {
            const item = document.getElementById('in-item').value, nick = document.getElementById('in-nick').value || "åŒ¿å";
            if(!item) return;
            const loc = document.getElementById('location-name').innerText.replace('ğŸ“ ','');
            await setDoc(doc(collection(db, "lost_items_v1")), { name:item, finder:nick, location:loc, x:clickPos.x, y:clickPos.y, createdAt:Date.now() });
            await setDoc(doc(db, "users_v1", nick), { merit: increment(50) }, { merge: true });
            closeModals();
        };

        function getMousePos(e) { const r = document.getElementById('map-root').getBoundingClientRect(); return { x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100 }; }
    </script>
</body>
</html>
