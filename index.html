<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU å¯¦å¢ƒåŠŸå¾·åœ°åœ– Pro+ (è† å›Šæ”¯æ´ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        
        .map-container {
            position: relative; width: 100%; height: 650px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid #fff; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);
        }

        .building-shape {
            position: absolute; transform-origin: center center; cursor: pointer;
            border: 2px solid transparent; 
        }
        /* è† å›Šå‹æ¨£å¼ï¼šä½¿ç”¨ 999px åœ“è§’ */
        .s-capsule { border-radius: 999px !important; background: rgba(79, 70, 229, 0.05); }
        .s-rect { border-radius: 4px; background: rgba(79, 70, 229, 0.05); }

        .selected-shape { border: 2px solid #4f46e5 !important; z-index: 50; background: rgba(79, 70, 229, 0.2); }

        /* æ§åˆ¶é»æ¨£å¼ */
        .handle {
            position: absolute; width: 12px; height: 12px; background: #fff;
            border: 2px solid #4f46e5; border-radius: 50%; pointer-events: auto;
        }
        .rotate-handle {
            position: absolute; width: 16px; height: 16px; background: #4f46e5;
            border: 2px solid #fff; border-radius: 50%; top: -35px; left: 50%;
            transform: translateX(-50%); cursor: grab;
        }
        .rotate-line {
            position: absolute; width: 2px; height: 25px; background: #4f46e5;
            top: -25px; left: 50%; transform: translateX(-50%);
        }

        .tool-btn { @apply px-4 py-2 text-white text-xs font-bold rounded-xl transition-all hover:scale-105 active:scale-95; }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                ğŸ’ NTCU åŠŸå¾·åœ°åœ– <span class="text-sm bg-indigo-100 text-indigo-600 px-2 py-1 rounded">PRO v2.1</span>
                <button id="admin-trigger" class="opacity-10 cursor-default text-xs">ADMIN</button>
            </h1>
            <div id="admin-panel" class="hidden flex flex-wrap gap-2 bg-slate-900 p-2 rounded-2xl shadow-xl">
                <button onclick="setTool('rect')" class="tool-btn bg-indigo-600">ï¼‹ çŸ©å½¢</button>
                <button onclick="setTool('capsule')" class="tool-btn bg-purple-600">ï¼‹ è† å›Š</button>
                <button onclick="deleteSelected()" class="tool-btn bg-red-500/80 hover:bg-red-500">åˆªé™¤é¸å–</button>
                <button onclick="toggleAdmin(false)" class="tool-btn bg-slate-700">å®Œæˆé€€å‡º</button>
            </div>
        </div>

        <div id="map-root" class="map-container overflow-hidden">
            <div id="shapes-layer" class="absolute inset-0"></div>
            <div id="pins-layer" class="absolute inset-0 pointer-events-none"></div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[200] backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl">
            <h2 class="text-2xl font-black mb-1">ç™¼ç¾ç‰©å“</h2>
            <p id="location-name" class="text-indigo-600 font-bold mb-6 italic">å®šä½ä¸­...</p>
            <input id="in-item" type="text" placeholder="éºå¤±ç‰©å“åç¨±" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 outline-none border-2 border-transparent focus:border-indigo-500">
            <input id="in-nick" type="text" placeholder="æ‚¨çš„æš±ç¨±" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 outline-none">
            <button id="btn-submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg hover:bg-indigo-700">å„²å­˜ä½ç½® (+50)</button>
            <button onclick="closeModals()" class="w-full py-2 text-slate-400 text-sm mt-2">æš«æ™‚ä¸ç”¨</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLL = "campus_data";
        const DOC = "NTCU-CAMPUS-V2"; 

        let buildings = [];
        let selectedId = null;
        let isAdmin = false;
        let isDragging = false, isRotating = false, isResizing = false;
        let currentHandle = null;
        let startPos = { x:0, y:0 };
        let adminClicks = 0;

        onSnapshot(doc(db, COLL, DOC), (snap) => {
            if (snap.exists()) {
                buildings = snap.data().buildings || [];
                render();
            }
        });

        // --- æ ¸å¿ƒé‹ç®—ï¼šæ”¯æ´çŸ©å½¢èˆ‡è† å›Šå‹çš„æ—‹è½‰åˆ¤å®š ---
        function isPointInShape(px, py, box) {
            const rad = -box.angle * Math.PI / 180;
            const cx = box.x + box.w / 2;
            const cy = box.y + box.h / 2;
            const dx = px - cx;
            const dy = py - cy;
            const rx = dx * Math.cos(rad) - dy * Math.sin(rad);
            const ry = dx * Math.sin(rad) + dy * Math.cos(rad);

            if (box.type === 'capsule') {
                const h = box.h, w = box.w;
                if (w >= h) { // æ©«å‘è† å›Š
                    const radius = h / 2;
                    const lineLen = w - h;
                    const posX = Math.max(-lineLen/2, Math.min(lineLen/2, rx));
                    const dist = Math.sqrt(Math.pow(rx - posX, 2) + Math.pow(ry, 2));
                    return dist <= radius;
                } else { // ç¸±å‘è† å›Š
                    const radius = w / 2;
                    const lineLen = h - w;
                    const posY = Math.max(-lineLen/2, Math.min(lineLen/2, ry));
                    const dist = Math.sqrt(Math.pow(rx, 2) + Math.pow(ry - posY, 2));
                    return dist <= radius;
                }
            }
            // çŸ©å½¢åˆ¤å®š
            return (Math.abs(rx) <= box.w / 2 && Math.abs(ry) <= box.h / 2);
        }

        function render() {
            const layer = document.getElementById('shapes-layer');
            layer.innerHTML = '';
            buildings.forEach((b, i) => {
                const el = document.createElement('div');
                el.className = `building-shape ${selectedId === i ? 'selected-shape' : ''} s-${b.type}`;
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg);`;
                
                if (isAdmin && selectedId === i) {
                    el.innerHTML = `
                        <div class="rotate-line"></div>
                        <div class="rotate-handle" onmousedown="startRotate(event)"></div>
                        <div class="handle" style="top:-6px;left:-6px;cursor:nw-resize" onmousedown="startResize(event,'nw')"></div>
                        <div class="handle" style="top:-6px;right:-6px;cursor:ne-resize" onmousedown="startResize(event,'ne')"></div>
                        <div class="handle" style="bottom:-6px;left:-6px;cursor:sw-resize" onmousedown="startResize(event,'sw')"></div>
                        <div class="handle" style="bottom:-6px;right:-6px;cursor:se-resize" onmousedown="startResize(event,'se')"></div>
                    `;
                }
                
                el.onmousedown = (e) => {
                    e.stopPropagation();
                    if (isAdmin) {
                        selectedId = i; isDragging = true;
                        startPos = getMousePos(e); render();
                    } else { checkHit(e); }
                };
                layer.appendChild(el);
            });
        }

        window.startRotate = (e) => { e.stopPropagation(); isRotating = true; };
        window.startResize = (e, handle) => { e.stopPropagation(); isResizing = true; currentHandle = handle; };

        window.addEventListener('mousemove', (e) => {
            if (!isAdmin || selectedId === null) return;
            const cur = getMousePos(e);
            const b = buildings[selectedId];

            if (isDragging) {
                b.x += (cur.x - startPos.x);
                b.y += (cur.y - startPos.y);
            } else if (isRotating) {
                const cx = b.x + b.w/2, cy = b.y + b.h/2;
                b.angle = Math.atan2(cur.y - cy, cur.x - cx) * 180 / Math.PI + 90;
            } else if (isResizing) {
                if (currentHandle.includes('e')) b.w = Math.max(1, b.w + (cur.x - (b.x + b.w)));
                if (currentHandle.includes('s')) b.h = Math.max(1, b.h + (cur.y - (b.y + b.h)));
                if (currentHandle.includes('w')) { const d = cur.x - b.x; b.x += d; b.w = Math.max(1, b.w - d); }
                if (currentHandle.includes('n')) { const d = cur.y - b.y; b.y += d; b.h = Math.max(1, b.h - d); }
            }
            if (isDragging || isRotating || isResizing) { startPos = cur; render(); }
        });

        window.addEventListener('mouseup', async () => {
            if (isDragging || isRotating || isResizing) { await save(); isDragging = isRotating = isResizing = false; }
        });

        function getMousePos(e) {
            const rect = document.getElementById('map-root').getBoundingClientRect();
            return { x: ((e.clientX - rect.left) / rect.width) * 100, y: ((e.clientY - rect.top) / rect.height) * 100 };
        }

        async function save() { await setDoc(doc(db, COLL, DOC), { buildings }); }

        window.setTool = async (type) => {
            const name = prompt("å€åŸŸåç¨±ï¼š", type === 'capsule' ? "æ–°æ­¥é“" : "æ–°å»ºç¯‰");
            if (!name) return;
            buildings.push({ x: 45, y: 45, w: 12, h: 6, angle: 0, name, type });
            selectedId = buildings.length - 1;
            await save();
        }

        window.deleteSelected = async () => {
            if (selectedId === null) return;
            buildings.splice(selectedId, 1);
            selectedId = null; await save();
        }

        window.toggleAdmin = (s) => {
            isAdmin = s;
            document.getElementById('admin-panel').classList.toggle('hidden', !s);
            selectedId = null; render();
        }

        document.getElementById('admin-trigger').onclick = () => { adminClicks++; if (adminClicks >= 5) toggleAdmin(true); };

        function checkHit(e) {
            const pos = getMousePos(e);
            let hitIndex = -1;
            for (let i = buildings.length - 1; i >= 0; i--) {
                if (isPointInShape(pos.x, pos.y, buildings[i])) { hitIndex = i; break; }
            }
            const name = hitIndex !== -1 ? buildings[hitIndex].name : "æ ¡åœ’é–‹æ”¾å€åŸŸ";
            document.getElementById('location-name').innerText = `ğŸ“ ${name}`;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        document.getElementById('map-root').onmousedown = (e) => {
            if (e.target.id === 'map-root' || e.target.id === 'shapes-layer') {
                if (!isAdmin) checkHit(e);
                else { selectedId = null; render(); }
            }
        };

        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
    </script>
</body>
</html>
