<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU äº’åŠ©æœƒ (ç’°å¢ƒæ¨“å°ˆç”¨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
        .map-container {
            position: relative; width: 100%; height: 600px;
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: hidden; cursor: crosshair;
        }
        #shapes-layer, #pins-layer { position: absolute; inset: 0; pointer-events: none; }
        #shapes-layer { z-index: 80; }
        #pins-layer { z-index: 90; }
        .building-shape { position: absolute; transform-origin: center; pointer-events: auto; background: transparent; }
        
        /* ç’°å¢ƒæ¨“å°ˆç”¨ï¼šç›´è§’ä¸‰è§’å½¢ CSS */
        .s-triangle { 
            clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
            -webkit-clip-path: polygon(0% 0%, 0% 100%, 100% 100%); 
        }

        .edit-controls { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); background: white; padding: 6px; border-radius: 10px; display: flex; gap: 5px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1000; }
        .edit-btn { padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; font-weight: bold; background: white; transition: all 0.2s; }
        .edit-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto text-center">
        <h1 class="text-2xl font-black text-slate-800 mb-2">ğŸ’ NTCU ç’°å¢ƒæ¨“å®šä½ç·¨è¼¯</h1>
        <p id="mode-indicator" class="text-slate-500 text-sm mb-6">é€£é»åœ°åœ– 3 ä¸‹é€²å…¥ç·¨è¼¯æ¨¡å¼</p>

        <div id="map-root" class="map-container" onclick="handleMapClick(event)">
            <div id="shapes-layer"></div>
            <div id="pins-layer"></div>
        </div>
        
        <p id="edit-tip" class="hidden mt-4 text-red-500 text-sm font-bold animate-bounce">
            ğŸ›  ç·¨è¼¯ä¸­ï¼šé»æ“Šç’°å¢ƒæ¨“ç´…æ¡†é¡¯ç¤ºæ§åˆ¶å°ï¼Œèª¿æ•´å®Œç•¢è«‹æŒ‰ ğŸ’¾ å­˜æª”ï¼
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let buildings = [], editMode = false;

        // æ ¸å¿ƒå¹¾ä½•åˆ¤å®š (ç›´è§’ä¸‰è§’å½¢)
        function isPointInShape(px, py, box) {
            const angleRad = (box.angle || 0) * Math.PI / 180;
            const cx = box.x + box.w / 2, cy = box.y + box.h / 2;
            const dx = px - cx, dy = py - cy;
            const rx = dx * Math.cos(-angleRad) - dy * Math.sin(-angleRad);
            const ry = dx * Math.sin(-angleRad) + dy * Math.cos(-angleRad);

            if (box.type === 'triangle') {
                const x1 = -box.w/2, y1 = -box.h/2, x2 = -box.w/2, y2 = box.h/2, x3 = box.w/2, y3 = box.h/2;
                const getArea = (xa, ya, xb, yb, xc, yc) => Math.abs((xa*(yb-yc) + xb*(yc-ya) + xc*(ya-yb))/2.0);
                const area = getArea(x1,y1,x2,y2,x3,y3);
                const a1 = getArea(rx,ry,x1,y1,x2,y2), a2 = getArea(rx,ry,x2,y2,x3,y3), a3 = getArea(rx,ry,x3,y3,x1,y1);
                return Math.abs(area - (a1 + a2 + a3)) < 2.5;
            }
            return false;
        }

        window.addEventListener('click', (e) => {
            if (e.detail === 3) {
                editMode = !editMode;
                document.getElementById('edit-tip').classList.toggle('hidden');
                document.getElementById('mode-indicator').innerText = editMode ? "ğŸ›  ç·¨è¼¯æ¨¡å¼å·²é–‹å•Ÿ" : "ç·¨è¼¯æ¨¡å¼å·²é—œé–‰";
                renderShapes();
            }
        });

        window.handleMapClick = (e) => {
            if (!editMode) return;
            const r = document.getElementById('map-root').getBoundingClientRect();
            const clickX = ((e.clientX-r.left)/r.width)*100;
            const clickY = ((e.clientY-r.top)/r.height)*100;

            const hitIndex = buildings.findIndex(b => isPointInShape(clickX, clickY, b));
            if (hitIndex === -1) {
                if (confirm("è¦åœ¨é€™è£¡æ–°å¢ç’°å¢ƒæ¨“å—ï¼Ÿ")) {
                    buildings.push({ name: "ç’°å¢ƒæ¨“", type: 'triangle', x: clickX-5, y: clickY-5, w: 12, h: 8, angle: 0 });
                    renderShapes();
                }
            }
        };

        window.adjust = (idx, prop, val) => {
            buildings[idx][prop] = Math.round((buildings[idx][prop] + val) * 10) / 10;
            renderShapes();
        };

        window.saveData = async () => {
            try {
                await updateDoc(CAMPUS_DOC, { buildings: buildings });
                alert("ç’°å¢ƒæ¨“å®šä½å·²æ›´æ–°æˆåŠŸï¼");
            } catch (err) { alert("å­˜æª”å¤±æ•—ï¼š" + err.message); }
        };

        function renderShapes() {
            const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
            buildings.forEach((b, i) => {
                if (b.name !== "ç’°å¢ƒæ¨“") return; // åƒ…è™•ç†ç’°å¢ƒæ¨“
                const el = document.createElement('div');
                el.className = `building-shape s-${b.type}`;
                const debug = editMode ? `border: 2px solid #ef4444; background: rgba(239,68,68,0.2);` : `background: transparent;`;
                el.style.cssText = `left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle||0}deg); ${debug}`;
                
                if (editMode) {
                    const ctrl = document.createElement('div');
                    ctrl.className = "edit-controls";
                    ctrl.innerHTML = `
                        <button class="edit-btn" onclick="event.stopPropagation();adjust(${i},'x',-0.2)">â¬…ï¸</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust(${i},'x',0.2)">â¡ï¸</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust(${i},'w',0.5)">å¯¬</button>
                        <button class="edit-btn" onclick="event.stopPropagation();adjust(${i},'h',0.5)">é«˜</button>
                        <button class="edit-btn text-blue-500" onclick="event.stopPropagation();adjust(${i},'angle',2)">ğŸ”„ æ—‹è½‰</button>
                        <button class="edit-btn text-green-600" onclick="event.stopPropagation();saveData()">ğŸ’¾ å­˜æª”</button>
                    `;
                    el.appendChild(ctrl);
                }
                layer.appendChild(el);
            });
        }

        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) { buildings = snap.data().buildings || []; renderShapes(); } });
    </script>
</body>
</html>
