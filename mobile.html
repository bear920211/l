<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NTCU äº’åŠ©æœƒ | æ‹¾ç‰©æ‰€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; overflow-x: hidden; }
        .tab-active { background-color: #4f46e5 !important; color: white !important; }
        .tab-lost-active { background-color: #ef4444 !important; color: white !important; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50">

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 px-4 py-3 border-b flex justify-between items-center">
        <h1 class="text-xl font-[900] text-slate-800 tracking-tighter">NTCU æ‹¾ç‰©æ‰€</h1>
        <div class="bg-white px-3 py-1 rounded-full border-2 border-indigo-100 shadow-sm">
            <span id="top-hero-name" class="text-xs font-black text-indigo-600 truncate max-w-[80px] inline-block align-middle">è¼‰å…¥ä¸­...</span>
        </div>
    </nav>

    <main class="p-4 space-y-4 pb-24">
        <div class="grid grid-cols-2 gap-3">
            <button onclick="openReport('found')" class="bg-indigo-600 text-white p-5 rounded-[2.5rem] shadow-lg flex flex-col items-center gap-1">
                <span class="text-2xl">ğŸ</span>
                <span class="font-black text-sm">æ’¿åˆ°æ±è¥¿</span>
            </button>
            <button onclick="openReport('lost')" class="bg-white text-slate-600 border-2 border-slate-100 p-5 rounded-[2.5rem] shadow-sm flex flex-col items-center gap-1">
                <span class="text-2xl">ğŸ”</span>
                <span class="font-black text-sm">éºå¤±ç‰©å“</span>
            </button>
        </div>

        <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl">
            <h3 class="text-[10px] font-black mb-4 flex items-center gap-2 opacity-80 tracking-widest uppercase">ğŸ† åŠŸå¾·æ¦œ</h3>
            <div id="leaderboard" class="space-y-3 text-xs"></div>
        </div>

        <div class="space-y-3">
            <h3 class="font-black text-slate-600 flex justify-between items-center px-2 text-sm">
                <span>æœ€æ–°å‹•æ…‹</span>
                <span id="items-count" class="text-indigo-500 font-bold">0</span>
            </h3>
            <div id="items-list" class="space-y-3"></div>
        </div>
    </main>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/60 hidden z-[100] p-4 flex items-end">
        <div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl animate-slide-up max-h-[95vh] overflow-y-auto text-center">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                <button onclick="switchTab('found')" id="tab-found" class="flex-1 py-2 rounded-xl font-black text-sm tab-active">æ’¿åˆ°æ±è¥¿</button>
                <button onclick="switchTab('lost')" id="tab-lost" class="flex-1 py-2 rounded-xl font-black text-sm text-slate-400">éºå¤±ç‰©å“</button>
            </div>

            <div class="mb-5"><div id="location-name" class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 text-sm font-black rounded-2xl italic">ğŸ“ é¸æ“‡æ ¡åœ’å€åŸŸ</div></div>
            
            <div class="space-y-3 mb-6 text-left">
                <select id="in-loc" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm appearance-none">
                    <option value="" disabled selected>è«‹é¸æ“‡ç‰©å“ä½ç½®</option>
                    <option value="æ•™å­¸å¤§æ¨“">æ•™å­¸å¤§æ¨“</option><option value="æ±‚çœŸæ¨“">æ±‚çœŸæ¨“</option>
                    <option value="ç’°å¢ƒæ¨“">ç’°å¢ƒæ¨“</option><option value="æ°‘ç”Ÿæ¨“">æ°‘ç”Ÿæ¨“</option>
                    <option value="ç¾è¡“æ¨“">ç¾è¡“æ¨“</option><option value="éŸ³æ¨‚æ¨“">éŸ³æ¨‚æ¨“</option>
                    <option value="é«”è‚²é¤¨">é«”è‚²é¤¨</option><option value="æ“å ´/çƒå ´">æ“å ´/çƒå ´</option>
                    <option value="åœ–æ›¸é¤¨">åœ–æ›¸é¤¨</option><option value="å…¶ä»–å€åŸŸ">å…¶ä»–å€åŸŸ</option>
                </select>
                <div class="relative">
                    <input type="text" id="in-nick" maxlength="10" placeholder="æš±ç¨±(å¿…å¡«ï¼Œæœ€å¤š10å­—)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                    <p id="nick-hint" class="text-[10px] mt-1 ml-2 font-bold text-slate-400"></p>
                </div>
                <input type="text" id="in-item" placeholder="ç‰©å“åç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <input type="text" id="in-floor" placeholder="å…·é«”ä½ç½® (ä¾‹ï¼šA302ã€çƒå ´)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <input type="text" id="in-desc" placeholder="è©³ç´°æè¿° (é¡è‰²ç‰¹å¾µã€å¤–è§€)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                
                <div class="p-3 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer text-center" onclick="document.getElementById('in-file').click()">
                    <input type="file" id="in-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <div id="preview-container" class="hidden"><img id="img-preview" src="" class="rounded-xl mx-auto max-h-24 object-cover"></div>
                    <div id="upload-placeholder" class="text-slate-400 text-[10px]">ğŸ“· æ‹ç…§ä¸Šå‚³ (é¸å¡«)</div>
                </div>
            </div>

            <button id="submit-btn" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg transition">ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)</button>
            <button onclick="closeModal()" class="mt-4 text-slate-400 font-bold text-xs">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LOST_COLL = collection(db, "all_reports_v3");
        const USER_COLL = collection(db, "users_v2");

        let currentTab = 'found';

        document.getElementById('in-nick').addEventListener('change', async (e) => {
            const nick = e.target.value.trim();
            const hint = document.getElementById('nick-hint');
            if(!nick) { hint.innerText = ""; return; }
            hint.innerText = "æŸ¥è©¢ä¸­...";
            const userSnap = await getDoc(doc(USER_COLL, nick));
            if(userSnap.exists()) {
                hint.innerHTML = `âœ… å·²è­˜åˆ¥è‹±é›„ï¼Œç›®å‰åŠŸå¾·ï¼š<span class="text-indigo-600 font-black">${userSnap.data().merit || 0}</span>`;
            } else {
                hint.innerHTML = `âœ¨ <span class="text-emerald-500 font-black">æ–°è‹±é›„ï¼</span>æ­¡è¿åŠ å…¥ã€‚`;
            }
        });

        onSnapshot(query(LOST_COLL, orderBy("time", "desc")), (s) => {
            const list = s.docs.map(d => ({id: d.id, ...d.data()}));
            document.getElementById('items-count').innerText = list.length;
            document.getElementById('items-list').innerHTML = list.map(i => `
                <div class="bg-white p-3 rounded-2xl border-l-4 ${i.type==='found'?'border-indigo-500':'border-red-500'} flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 bg-slate-100 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-full object-cover">` : 'ğŸ'}
                    </div>
                    <div class="flex-1 truncate text-left font-bold text-sm text-slate-700">
                        ${i.name}
                        <div class="text-[9px] text-slate-400 italic">${i.location}</div>
                    </div>
                </div>
            `).join('');
        });

        onSnapshot(query(USER_COLL, orderBy("merit", "desc"), limit(5)), (s) => {
            document.getElementById('leaderboard').innerHTML = s.docs.map((d, i) => `
                <div class="flex justify-between items-center p-2 bg-white/10 rounded-xl text-[11px]">
                    <span>${i+1}. ${d.id}</span><b>${d.data().merit || 0} pts</b>
                </div>`).join('');
            if(s.docs[0]) document.getElementById('top-hero-name').innerText = s.docs[0].id;
        });

        window.openReport = (type) => { switchTab(type); document.getElementById('report-modal').classList.remove('hidden'); };

        window.switchTab = (t) => {
            currentTab = t;
            document.getElementById('tab-found').className = t==='found' ? "flex-1 py-2 rounded-xl font-black text-sm tab-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            document.getElementById('tab-lost').className = t==='lost' ? "flex-1 py-2 rounded-xl font-black text-sm tab-lost-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            const btn = document.getElementById('submit-btn');
            btn.innerText = t === 'found' ? "ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)" : "ç™¼å¸ƒæ±‚åŠ©æ¨™è¨˜";
            btn.className = `w-full py-4 text-white font-black rounded-2xl shadow-lg ${t==='found'?'bg-indigo-600':'bg-red-500'}`;
        };

        window.closeModal = () => {
            document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('nick-hint').innerText = "";
        };

        window.previewImage = (input) => {
            const f = input.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height, max = 800;
                    if (width > height) { if (width > max) { height *= max / width; width = max; } }
                    else { if (height > max) { width *= max / height; height = max; } }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    document.getElementById('img-preview').src = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-placeholder').classList.add('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(f);
        };

        document.getElementById('submit-btn').onclick = async () => {
            const nick = document.getElementById('in-nick').value.trim();
            const item = document.getElementById('in-item').value.trim();
            const loc = document.getElementById('in-loc').value;
            if(!nick || !item || !loc) return alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼");
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "ä¸Šå‚³ä¸­...";
            try {
                await setDoc(doc(LOST_COLL), {
                    type: currentTab, name: item, finder: nick, location: loc,
                    floor_info: document.getElementById('in-floor').value,
                    description: document.getElementById('in-desc').value,
                    imageUrl: document.getElementById('img-preview').src.startsWith('data:image') ? document.getElementById('img-preview').src : "",
                    time: Date.now(), x: 50, y: 50
                });
                if(currentTab === 'found') {
                    await updateDoc(doc(USER_COLL, nick), { merit: increment(50) }).catch(async () => {
                        await setDoc(doc(USER_COLL, nick), { merit: 50 });
                    });
                }
                alert("ç™¼å¸ƒæˆåŠŸï¼");
                location.reload();
            } catch(e) { alert("å¤±æ•—ï¼"); btn.disabled = false; }
        };
    </script>
</body>
</html>
