<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NTCU äº’åŠ©æœƒ | æ‹¾ç‰©æ‰€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; overflow-x: hidden; }

        /* åœ°åœ–è¦–å£ï¼šç¶­æŒåŸæœ¬åœ“è§’å¡ç‰‡æ„Ÿ */
        .map-viewport {
            position: relative; width: 100%; height: 480px;
            background: #e2e8f0; border-radius: 2.5rem; border: 8px solid white; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: hidden; touch-action: none; /* äº¤ç”± JS è™•ç†ç¸®æ”¾èˆ‡æ‹–æ›³ */
        }

        /* åœ°åœ–ç•«å¸ƒï¼šæ­¤å±¤ç´šæœƒè¢«æ”¾å¤§ */
        .map-canvas {
            position: relative; width: 100%; height: 100%;
            background: url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            transform-origin: center center;
            cursor: crosshair;
        }

        /* å½ˆçª—ï¼šå›ºå®šåœ¨è¢å¹•ä¸­å¤®ï¼Œå¤§å°ä¸éš¨åœ°åœ–æ”¾å¤§ */
        .fixed-modal {
            position: fixed !important; inset: 0; z-index: 500;
            display: flex; align-items: center; justify-content: center;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
        }

        #shapes-layer, #pins-layer { position: absolute; inset: 0; pointer-events: none; }
        #shapes-layer { z-index: 10; opacity: 0; } 
        #pins-layer { z-index: 20; }
        .floating-pin { position: absolute; transform: translate(-50%, -50%); cursor: pointer; pointer-events: auto; }
        .pin-dot { width: 18px; height: 18px; border-radius: 50%; border: 2.5px solid white; box-shadow: 0 0 12px rgba(0,0,0,0.3); animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0.4); transform: scale(1); }
            70% { box-shadow: 0 0 0 12px rgba(79, 70, 229, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0); transform: scale(1); }
        }
        .tab-active { background-color: #4f46e5 !important; color: white !important; }
        .tab-lost-active { background-color: #ef4444 !important; color: white !important; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-md mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-[900] text-slate-800 tracking-tighter mb-1">NTCU æ‹¾ç‰©æ‰€</h1>
            <p class="text-slate-500 text-sm font-bold pl-1">é›™æŒ‡æ’¥é–‹åœ°åœ–å¯æ”¾å¤§ ğŸ“</p>
        </header>

        <div class="map-viewport" id="zoom-area">
            <div id="map-root" class="map-canvas" onclick="handleMapClick(event)">
                <div id="shapes-layer"></div>
                <div id="pins-layer"></div>
            </div>
        </div>

        <div class="mt-8 space-y-4">
            <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm">ğŸ† åŠŸå¾·æ¦œ</h3>
                    <span id="top-hero-name" class="text-[10px] bg-white/20 px-3 py-1 rounded-full font-black">è¼‰å…¥ä¸­...</span>
                </div>
                <div id="leaderboard" class="space-y-2 text-xs"></div>
            </div>
            <div class="bg-white rounded-[2.5rem] shadow-sm border p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <span class="font-black text-slate-600 text-sm">æœ€æ–°å‹•æ…‹</span>
                    <span id="items-count" class="text-indigo-500 font-bold bg-indigo-50 px-3 py-1 rounded-full text-xs">0</span>
                </div>
                <div id="items-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed-modal hidden p-4">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full p-6 shadow-2xl text-center">
            <div class="flex bg-slate-100 p-1 rounded-2xl mb-4">
                <button onclick="switchTab('found')" id="tab-found" class="flex-1 py-2 rounded-xl font-black text-sm tab-active">æ’¿åˆ°æ±è¥¿</button>
                <button onclick="switchTab('lost')" id="tab-lost" class="flex-1 py-2 rounded-xl font-black text-sm text-slate-400">éºå¤±ç‰©å“</button>
            </div>
            <div class="mb-5"><div id="location-name" class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-black rounded-2xl italic">å®šä½ä¸­...</div></div>
            <div class="space-y-3 mb-6">
                <input type="text" id="in-nick" maxlength="10" placeholder="æš±ç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <input type="text" id="in-item" placeholder="ç‰©å“åç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <input type="text" id="in-floor" placeholder="å…·é«”ä½ç½® (ä¾‹ï¼šA302)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <input type="text" id="in-desc" placeholder="è©³ç´°æè¿° (é¡è‰²ã€ç‰¹å¾µ)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none text-sm">
                <div class="p-3 border-2 border-dashed border-slate-200 rounded-2xl text-center" onclick="document.getElementById('in-file').click()">
                    <input type="file" id="in-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <div id="preview-container" class="hidden"><img id="img-preview" src="" class="rounded-xl mx-auto max-h-20"></div>
                    <div id="upload-placeholder" class="text-slate-400 text-[10px] font-bold italic">ğŸ“· æ‹ç…§ä¸Šå‚³ (é¸å¡«)</div>
                </div>
            </div>
            <button id="submit-btn" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg">ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)</button>
            <button onclick="closeModals()" class="mt-4 text-slate-400 font-bold text-xs underline">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="detail-modal" class="fixed-modal hidden p-4">
        <div class="bg-white rounded-[2.5rem] max-w-sm w-full overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="w-full bg-slate-100 flex items-center justify-center relative min-h-[150px]">
                <img id="detail-img" src="" class="w-full h-auto max-h-[40vh] object-contain block">
                <div id="no-img-placeholder" class="hidden text-slate-300 font-bold text-xs py-16 uppercase italic">No Photo</div>
                <div id="type-tag" class="absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white z-10"></div>
            </div>
            <div class="p-6 overflow-y-auto text-left">
                <h2 id="detail-name" class="text-xl font-black text-slate-800 mb-1">ç‰©å“åç¨±</h2>
                <p id="detail-loc" class="text-slate-400 font-bold text-xs mb-4 italic"></p>
                <div class="grid grid-cols-1 gap-3 mb-6 text-xs">
                    <div class="bg-slate-50 rounded-xl p-3 border-l-4 border-indigo-500 font-bold">ä½ç½®ï¼š<span id="detail-floor" class="text-slate-600"></span></div>
                    <div class="bg-amber-50 rounded-xl p-3 border-l-4 border-amber-400 font-bold">æè¿°ï¼š<span id="detail-desc" class="text-slate-600"></span></div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-claim-now" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg">æ˜¯æˆ‘çš„ï¼</button>
                    <button onclick="closeDetail()" class="px-6 py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase åˆå§‹åŒ– (ç¶­æŒä¸è®Š)
        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LOST_COLL = collection(db, "all_reports_v3");
        const USER_COLL = collection(db, "users_v2");
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let currentTab = 'found', buildings = [], reports = [], clickPos = {x:50, y:50};
        let scale = 1, lastDist = 0;

        // é›™æŒ‡ç¸®æ”¾èˆ‡æ‹–æ›³é‚è¼¯ (åƒ…é™åœ°åœ–)
        const zoomArea = document.getElementById('zoom-area');
        const mapRoot = document.getElementById('map-root');

        zoomArea.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                if (lastDist) {
                    scale = Math.min(Math.max(1, scale * (dist / lastDist)), 4);
                    mapRoot.style.transform = `scale(${scale})`;
                }
                lastDist = dist;
            }
        }, { passive: false });

        zoomArea.addEventListener('touchend', () => { lastDist = 0; });

        // é»æ“Šåº§æ¨™æ ¡æ­£
        window.handleMapClick = (e) => {
            if (e.target.closest('.floating-pin')) return;
            const r = mapRoot.getBoundingClientRect();
            clickPos = { 
                x: ((e.clientX - r.left) / r.width) * 100, 
                y: ((e.clientY - r.top) / r.height) * 100 
            };
            const hit = buildings.find(b => clickPos.x >= b.x && clickPos.x <= b.x + b.w && clickPos.y >= b.y && clickPos.y <= b.y + b.h);
            document.getElementById('location-name').innerText = `ğŸ“ ${hit ? hit.name : "æ ¡åœ’é–‹æ”¾å€åŸŸ"}`;
            document.getElementById('report-modal').classList.remove('hidden');
        };

        // ... å…¶é¤˜ Firebase é‚è¼¯ç¶­æŒåŸæœ¬ä»£ç¢¼ ...
        onSnapshot(CAMPUS_DOC, (snap) => { if (snap.exists()) buildings = snap.data().buildings || []; });
        onSnapshot(LOST_COLL, (s) => {
            reports = s.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('items-count').innerText = reports.length;
            renderPins(); renderList();
        });
        onSnapshot(query(USER_COLL, orderBy("merit", "desc"), limit(5)), (s) => {
            document.getElementById('leaderboard').innerHTML = s.docs.map((d, i) => `
                <div class="flex justify-between items-center p-3 bg-white/10 rounded-xl">
                    <span class="font-black">${i+1}. ${d.id}</span>
                    <span class="bg-white/20 px-2 py-0.5 rounded-lg">${d.data().merit || 0} PTS</span>
                </div>`).join('');
            if(s.docs[0]) document.getElementById('top-hero-name').innerText = s.docs[0].id;
        });

        window.switchTab = (t) => {
            currentTab = t;
            document.getElementById('tab-found').className = t==='found' ? "flex-1 py-2 rounded-xl font-black text-sm tab-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            document.getElementById('tab-lost').className = t==='lost' ? "flex-1 py-2 rounded-xl font-black text-sm tab-lost-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
        };

        document.getElementById('submit-btn').onclick = async () => {
            const nick = document.getElementById('in-nick').value.trim();
            const item = document.getElementById('in-item').value.trim();
            if(!nick || !item) return alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼");
            await setDoc(doc(LOST_COLL), {
                type: currentTab, name: item, finder: nick,
                floor_info: document.getElementById('in-floor').value,
                description: document.getElementById('in-desc').value,
                location: document.getElementById('location-name').innerText.replace('ğŸ“ ',''),
                imageUrl: document.getElementById('img-preview').src.startsWith('data:image') ? document.getElementById('img-preview').src : "",
                x: clickPos.x, y: clickPos.y, time: Date.now()
            });
            if(currentTab === 'found') await updateDoc(doc(USER_COLL, nick), { merit: increment(50) }).catch(() => setDoc(doc(USER_COLL, nick), { merit: 50 }));
            location.reload(); // é€å‡ºå¾Œè‡ªå‹•åˆ·æ–°ä¸¦é‡ç½®å¤§å°
        };

        // æ¸²æŸ“ Pins
        function renderPins() {
            const layer = document.getElementById('pins-layer'); layer.innerHTML = '';
            reports.forEach(i => {
                const p = document.createElement('div'); p.className = 'floating-pin';
                p.style.left = `${i.x}%`; p.style.top = `${i.y}%`;
                p.innerHTML = `<div class="pin-dot ${i.type === 'found' ? 'bg-indigo-600' : 'bg-red-500'}"></div>`;
                p.onclick = (e) => { e.stopPropagation(); openDetail(i.id); };
                layer.appendChild(p);
            });
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            document.getElementById('items-list').innerHTML = reports.sort((a,b)=>b.time-a.time).map(i => `
                <div onclick="openDetail('${i.id}')" class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-full object-cover">` : 'ğŸ'}
                    </div>
                    <div class="flex-1 truncate text-left text-sm font-bold text-slate-700">${i.name}</div>
                </div>`).join('');
        }

        window.openDetail = (id) => {
            const item = reports.find(i => i.id === id); if(!item) return;
            const tag = document.getElementById('type-tag');
            tag.innerText = item.type === 'found' ? 'æ‹¾ç²ç‰©' : 'å”å°‹ä¸­';
            tag.className = `absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white ${item.type==='found'?'bg-indigo-600':'bg-red-500'}`;
            document.getElementById('detail-name').innerText = item.name;
            document.getElementById('detail-loc').innerText = `ğŸ“ ${item.location}`;
            document.getElementById('detail-floor').innerText = item.floor_info || "å°šæœªæ¨™è¨»";
            document.getElementById('detail-desc').innerText = item.description || "ç„¡ã€‚";
            const img = document.getElementById('detail-img'), ph = document.getElementById('no-img-placeholder');
            if(item.imageUrl) { img.src = item.imageUrl; img.classList.remove('hidden'); ph.classList.add('hidden'); }
            else { img.classList.add('hidden'); ph.classList.remove('hidden'); }
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        window.previewImage = (input) => {
            const f = input.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(f);
        };

        window.closeModals = () => document.getElementById('report-modal').classList.add('hidden');
        window.closeDetail = () => document.getElementById('detail-modal').classList.add('hidden');
    </script>
</body>
</html>
