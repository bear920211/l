<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTCU äº’åŠ©æœƒ | æ‹¾ç‰©æ‰€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; overflow-x: hidden; }
        
        .map-container {
            position: relative; width: 100%; aspect-ratio: 1191 / 855; 
            background: #e2e8f0 url('https://i.ibb.co/DPQm11wf/1.png') no-repeat center/contain;
            border-radius: 2.5rem; border: 8px solid white; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            overflow: hidden; cursor: crosshair;
        }

        #shapes-layer, #pins-layer { position: absolute; inset: 0; pointer-events: none; }
        #shapes-layer { z-index: 10; opacity: 0; } 
        #pins-layer { z-index: 20; }
        .building-shape { position: absolute; background: transparent; transform-origin: center; } 
        .is-triangle { clip-path: polygon(0% 0%, 0% 100%, 100% 100%); -webkit-clip-path: polygon(0% 0%, 0% 100%, 100% 100%); }
        
        .floating-pin { position: absolute; transform: translate(-50%, -50%); cursor: pointer; pointer-events: auto; }
        .pin-dot { 
            width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid white; 
            box-shadow: 0 0 8px rgba(0,0,0,0.3); animation: pulse 2s infinite; 
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0.3); transform: scale(1); }
            70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0); transform: scale(1); }
        }

        .info-tab-active { background: white; color: #4f46e5; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .tab-active { background-color: #4f46e5 !important; color: white !important; }
        .tab-lost-active { background-color: #ef4444 !important; color: white !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-md mx-auto pb-10">
        <header class="flex flex-col gap-4 mb-6 text-left">
            <div>
                <h1 class="text-4xl font-[900] text-slate-800 tracking-tighter mb-1">NTCU æ‹¾ç‰©æ‰€</h1>
                <p class="text-slate-600 text-[13px] font-black mb-4 pl-1">
                    é»æ“Šåœ°åœ–æ¨™è¨»ï¼š<span class="text-indigo-600">è—è‰²æ‹¾ç²</span> / <span class="text-red-500">ç´…è‰²éºå¤±</span>
                </p>
                <div class="bg-white p-4 px-6 rounded-[2rem] shadow-sm border-2 border-indigo-100 w-full flex justify-between items-center">
                    <div>
                        <span class="text-[10px] font-black text-slate-400 block tracking-[0.2em]">TOP HERO</span>
                        <span id="top-hero-name" class="text-xl font-black text-indigo-600 truncate block">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </header>

        <div id="map-root" class="map-container mb-6" onclick="handleMapClick(event)">
            <div id="shapes-layer"></div>
            <div id="pins-layer"></div>
        </div>

        <div class="bg-slate-100 p-1.5 rounded-[2.5rem] flex mb-4">
            <button onclick="switchInfoTab('news')" id="btn-news" class="flex-1 py-3 rounded-[2rem] font-black text-sm info-tab-active flex items-center justify-center gap-2">
                æœ€æ–°å‹•æ…‹
                <span id="news-count-badge" class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-[10px] font-black">0</span>
            </button>
            <button onclick="switchInfoTab('rank')" id="btn-rank" class="flex-1 py-3 rounded-[2rem] font-black text-sm text-slate-500">åŠŸå¾·æ¦œ</button>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-sm border h-[380px] overflow-hidden flex flex-col">
            <div id="panel-news" class="flex-1 overflow-y-auto p-4">
                <div id="items-list" class="space-y-3"></div>
            </div>
            <div id="panel-rank" class="hidden flex-1 overflow-y-auto p-6">
                <div id="leaderboard" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-slate-900/40 hidden flex items-center justify-center z-[300] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] w-full max-w-[350px] max-h-[90vh] flex flex-col p-6 shadow-2xl text-center overflow-hidden">
            <div class="flex-shrink-0 flex bg-slate-100 p-1 rounded-2xl mb-4">
                <button onclick="switchReportTab('found')" id="tab-found" class="flex-1 py-2 rounded-xl font-black text-sm tab-active">æ’¿åˆ°æ±è¥¿</button>
                <button onclick="switchReportTab('lost')" id="tab-lost" class="flex-1 py-2 rounded-xl font-black text-sm text-slate-400">éºå¤±ç‰©å“</button>
            </div>
            <div class="flex-shrink-0 mb-4"><div id="location-name" class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 text-base font-black rounded-2xl">å®šä½ä¸­...</div></div>
            
            <div class="flex-1 overflow-y-auto space-y-3 mb-6 text-left px-1">
                <div>
                    <input type="text" id="in-nick" maxlength="10" placeholder="æš±ç¨±(å¿…å¡«ï¼Œæœ€å¤š10å­—)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                    <div id="nick-hint" class="text-[10px] pl-4 pt-1 h-4 font-bold"></div>
                </div>
                <input type="text" id="in-item" placeholder="ç‰©å“åç¨±(å¿…å¡«)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="in-floor" placeholder="å…·é«”ä½ç½® (ä¾‹ï¼šA302ã€çƒå ´)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="in-desc" placeholder="è©³ç´°æè¿° (é¡è‰²ã€ç‰¹å¾µ)" class="w-full px-5 py-3 bg-slate-50 border rounded-2xl font-bold outline-none">
                <div class="p-3 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer text-center relative" onclick="document.getElementById('in-file').click()">
                    <input type="file" id="in-file" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <div id="preview-container" class="hidden"><img id="img-preview" src="" class="rounded-xl mx-auto max-h-24 object-cover"></div>
                    <div id="upload-placeholder" class="text-slate-400 text-[10px] py-2">ğŸ“· é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡ (é¸å¡«)</div>
                </div>
            </div>
            <div class="flex-shrink-0">
                <button id="submit-btn" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg transition">ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)</button>
                <button onclick="closeModals()" class="mt-4 text-slate-400 font-bold text-xs uppercase tracking-widest">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-[400] p-4 backdrop-blur-md">
        <div class="bg-white rounded-[2.5rem] w-full max-w-[350px] max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
            <div class="flex-shrink-0 w-full h-[200px] bg-slate-100 flex items-center justify-center relative border-b">
                <img id="detail-img" src="" class="w-full h-full object-cover block">
                <div id="no-img-placeholder" class="hidden text-slate-300 font-black text-sm py-16">ğŸ“· ç„¡ç…§ç‰‡é è¦½</div>
                <div id="type-tag" class="absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white z-10 shadow-lg"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 text-left">
                <h2 id="detail-name" class="text-2xl font-black text-slate-800 mb-1 leading-tight"></h2>
                <div class="flex justify-between items-center mb-4">
                    <p id="detail-loc" class="text-slate-400 font-bold text-xs"></p>
                    <span class="text-[9px] bg-slate-100 px-2 py-0.5 rounded-lg text-slate-500 font-black italic">ç”± <span id="detail-finder"></span> æä¾›</span>
                </div>
                <div class="space-y-3 mb-6">
                    <div class="bg-indigo-50/50 rounded-2xl p-4 border-l-4 border-indigo-500">
                        <p class="text-[9px] text-indigo-400 font-black uppercase mb-1">å…·é«”ä½ç½®</p>
                        <p id="detail-floor" class="font-bold text-sm text-slate-700"></p>
                    </div>
                    <div class="bg-amber-50 rounded-2xl p-4 border-l-4 border-amber-400">
                        <p class="text-[9px] text-amber-500 font-black uppercase mb-1">è©³ç´°æè¿°</p>
                        <p id="detail-desc" class="font-bold text-sm text-slate-700"></p>
                    </div>
                </div>
            </div>
            <div class="flex-shrink-0 p-6 pt-0 flex gap-2">
                <button id="btn-claim-now" class="flex-1 py-4 bg-emerald-500 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">æ˜¯æˆ‘çš„ï¼</button>
                <button onclick="closeDetail()" class="px-6 py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, increment, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDnKRElPR1agzd5Lknzbqrv9kJtiD_bKsY",
            authDomain: "lostandnotfound-6d007.firebaseapp.com",
            projectId: "lostandnotfound-6d007",
            storageBucket: "lostandnotfound-6d007.firebasestorage.app",
            messagingSenderId: "456947474024",
            appId: "1:456947474024:web:18382370a1f9ca5c0765dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const LOST_COLL = collection(db, "all_reports_v3");
        const USER_COLL = collection(db, "users_v2");
        const CAMPUS_DOC = doc(db, "campus_data", "NTCU-CAMPUS-V2");

        let currentReportTab = 'found', buildings = [], reports = [], clickPos = {x:50, y:50};

        document.getElementById('in-nick').addEventListener('change', async (e) => {
            const nick = e.target.value.trim();
            const hint = document.getElementById('nick-hint');
            if(!nick) { hint.innerText = ""; return; }
            hint.innerText = "æŸ¥è©¢ä¸­...";
            try {
                const userSnap = await getDoc(doc(USER_COLL, nick));
                if(userSnap.exists()) {
                    hint.innerHTML = `âœ… å·²è­˜åˆ¥ï¼ŒåŠŸå¾·ï¼š<span class="text-indigo-600 font-black">${userSnap.data().merit || 0}</span>`;
                } else {
                    hint.innerHTML = `âœ¨ <span class="text-emerald-500 font-black">æ­¡è¿åŠ å…¥æ‹¾ç‰©æ‰€ã€‚</span>`;
                }
            } catch(e) { hint.innerText = ""; }
        });

        window.switchInfoTab = (tab) => {
            const isNews = tab === 'news';
            document.getElementById('btn-news').classList.toggle('info-tab-active', isNews);
            document.getElementById('btn-rank').classList.toggle('info-tab-active', !isNews);
            document.getElementById('panel-news').classList.toggle('hidden', !isNews);
            document.getElementById('panel-rank').classList.toggle('hidden', isNews);
        };

        window.switchReportTab = (t) => {
            currentReportTab = t;
            document.getElementById('tab-found').className = t==='found' ? "flex-1 py-2 rounded-xl font-black text-sm tab-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            document.getElementById('tab-lost').className = t==='lost' ? "flex-1 py-2 rounded-xl font-black text-sm tab-lost-active" : "flex-1 py-2 rounded-xl font-black text-sm text-slate-400";
            const btn = document.getElementById('submit-btn');
            btn.innerText = t === 'found' ? "ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)" : "ç™¼å¸ƒæ±‚åŠ©æ¨™è¨˜";
            btn.className = `w-full py-4 text-white font-black rounded-2xl shadow-lg transition ${t==='found'?'bg-indigo-600':'bg-red-500'}`;
        };

        onSnapshot(LOST_COLL, (s) => {
            reports = s.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('news-count-badge').innerText = reports.length;
            renderPins(); renderList();
        });

        onSnapshot(query(USER_COLL, orderBy("merit", "desc"), limit(10)), (s) => {
            document.getElementById('leaderboard').innerHTML = s.docs.map((d, i) => `
                <div class="flex items-center gap-4">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-black text-xs ${i<3 ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}">${i+1}</div>
                    <div class="flex-1 border-b border-slate-50 pb-2 flex justify-between items-center">
                        <span class="font-bold text-slate-700">${d.id}</span>
                        <span class="font-black text-indigo-500 text-xs">${d.data().merit || 0} PTS</span>
                    </div>
                </div>`).join('');
            if(s.docs[0]) document.getElementById('top-hero-name').innerText = s.docs[0].id;
        });

        function renderPins() {
            const layer = document.getElementById('pins-layer'); layer.innerHTML = '';
            reports.forEach(i => {
                const p = document.createElement('div'); p.className = 'floating-pin';
                p.style.left = `${i.x}%`; p.style.top = `${i.y}%`;
                p.innerHTML = `<div class="pin-dot ${i.type === 'found' ? 'bg-indigo-600' : 'bg-red-500'}"></div>`;
                p.onclick = (e) => { e.stopPropagation(); openDetail(i.id); };
                layer.appendChild(p);
            });
        }

        function renderList() {
            const list = document.getElementById('items-list');
            if(!list) return;
            list.innerHTML = reports.sort((a,b)=>b.time-a.time).map(i => {
                const isFoundType = (i.type && i.type.toString().trim().toLowerCase() === 'found');
                const hexColor = isFoundType ? '#4f46e5' : '#ef4444'; 
                const textHighlight = isFoundType ? 'text-indigo-600' : 'text-red-600';
                return `
                <div onclick="openDetail('${i.id}')" style="border-left: 6px solid ${hexColor};" class="p-3 bg-white rounded-2xl flex items-center gap-3 cursor-pointer shadow-sm border border-slate-100 mb-3 active:scale-[0.98] transition-all">
                    <div class="w-10 h-10 bg-slate-50 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border border-slate-50">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-full object-cover">` : '<span class="text-lg">ğŸ</span>'}
                    </div>
                    <div class="flex-1 truncate text-left font-black text-sm text-slate-700">
                        ${i.name}
                        <div class="text-[10px] text-slate-400 font-bold">ğŸ“ ${i.location}</div>
                    </div>
                    <div class="text-[9px] font-black ${textHighlight} bg-slate-50 px-2 py-1 rounded border border-slate-100">
                        ${isFoundType ? 'æ‹¾ç²' : 'éºå¤±'}
                    </div>
                </div>`;
            }).join('');
        }

        window.handleMapClick = (e) => {
            const r = document.getElementById('map-root').getBoundingClientRect();
            clickPos = { x:((e.clientX-r.left)/r.width)*100, y:((e.clientY-r.top)/r.height)*100 };
            const hit = buildings.find(b => checkHit(clickPos.x, clickPos.y, b));
            document.getElementById('location-name').innerText = `ğŸ“ ${hit ? hit.name : "æ ¡åœ’é–‹æ”¾å€åŸŸ"}`;
            document.getElementById('report-modal').classList.remove('hidden');
        };

        function checkHit(px, py, b) {
            if (b.name === "ç’°å¢ƒæ¨“") {
                const rad = (b.angle || 0) * Math.PI / 180, cx = b.x + b.w/2, cy = b.y + b.h/2;
                const dx = px - cx, dy = py - cy;
                const rx = dx * Math.cos(-rad) - dy * Math.sin(-rad), ry = dx * Math.sin(-rad) + dy * Math.cos(-rad);
                const x1 = -b.w/2, y1 = -b.h/2, x2 = -b.w/2, y2 = b.h/2, x3 = b.w/2, y3 = b.h/2;
                const getArea = (xa,ya,xb,yb,xc,yc) => Math.abs((xa*(yb-yc)+xb*(yc-ya)+xc*(ya-yb))/2);
                const total = getArea(x1,y1,x2,y2,x3,y3);
                const pArea = getArea(rx,ry,x1,y1,x2,y2) + getArea(rx,ry,x2,y2,x3,y3) + getArea(rx,ry,x3,y3,x1,y1);
                return Math.abs(total - pArea) < 1.0;
            }
            return px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h;
        }

        onSnapshot(CAMPUS_DOC, (snap) => {
            if (snap.exists()) {
                buildings = snap.data().buildings || [];
                const layer = document.getElementById('shapes-layer');
                layer.innerHTML = buildings.map(b => `<div class="building-shape ${b.name==='ç’°å¢ƒæ¨“'?'is-triangle':''}" style="left:${b.x}%; top:${b.y}%; width:${b.w}%; height:${b.h}%; transform:rotate(${b.angle || 0}deg);"></div>`).join('');
            }
        });

        window.openDetail = (id) => {
            const item = reports.find(i => i.id === id); if(!item) return;
            document.getElementById('detail-name').innerText = item.name;
            document.getElementById('detail-loc').innerText = `ğŸ“ ${item.location}`;
            document.getElementById('detail-floor').innerText = item.floor_info || "ç„¡è©³ç´°ä½ç½®";
            document.getElementById('detail-finder').innerText = item.finder || "åŒ¿å";
            document.getElementById('detail-desc').innerText = item.description || "ç„¡æè¿°å…§å®¹ã€‚";
            
            const isFound = item.type === 'found';
            const tag = document.getElementById('type-tag');
            tag.innerText = isFound ? 'æ‹¾ç²ç‰©' : 'å”å°‹ä¸­';
            tag.className = `absolute top-4 left-4 px-4 py-1 rounded-full text-[10px] font-black text-white z-10 shadow-lg ${isFound?'bg-indigo-600':'bg-red-500'}`;
            
            const claimBtn = document.getElementById('btn-claim-now');
            // æŒ‰éˆ•æ–‡å­—åˆ¤æ–·
            claimBtn.innerText = isFound ? 'æ˜¯æˆ‘çš„ï¼' : 'æ‰¾åˆ°äº†ï¼';

            const img = document.getElementById('detail-img'), ph = document.getElementById('no-img-placeholder');
            if(item.imageUrl) { img.src = item.imageUrl; img.classList.remove('hidden'); ph.classList.add('hidden'); }
            else { img.classList.add('hidden'); ph.classList.remove('hidden'); }
            
            claimBtn.onclick = async () => {
                const confirmText = isFound ? 'ç¢ºèªè¦é ˜å›é€™ä»¶ç‰©å“å—ï¼Ÿ' : 'æ‚¨æ˜¯å¦å·²ç¶“æ‰¾å›é€™ä»¶éºå¤±ç‰©ï¼Ÿ';
                if(confirm(confirmText)){
                    if(isFound && item.finder) await updateDoc(doc(USER_COLL, item.finder), { merit: increment(20) }).catch(() => setDoc(doc(USER_COLL, item.finder), { merit: 20 }));
                    await deleteDoc(doc(db, "all_reports_v3", id));
                    closeDetail();
                }
            };
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        document.getElementById('submit-btn').onclick = async () => {
            const nick = document.getElementById('in-nick').value.trim(), item = document.getElementById('in-item').value.trim();
            if(!nick || !item) return alert("è«‹å¡«å¯«æš±ç¨±èˆ‡ç‰©å“åç¨±ï¼");
            const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.innerText = "è³‡æ–™å‚³è¼¸ä¸­...";
            try {
                await setDoc(doc(LOST_COLL), {
                    type: currentReportTab, name: item, finder: nick, floor_info: document.getElementById('in-floor').value,
                    description: document.getElementById('in-desc').value, location: document.getElementById('location-name').innerText.replace('ğŸ“ ',''),
                    imageUrl: document.getElementById('img-preview').src.startsWith('data:image') ? document.getElementById('img-preview').src : "",
                    x: clickPos.x, y: clickPos.y, time: Date.now()
                });
                if(currentReportTab === 'found') await updateDoc(doc(USER_COLL, nick), { merit: increment(50) }).catch(() => setDoc(doc(USER_COLL, nick), { merit: 50 }));
                alert("ç™¼å¸ƒæˆåŠŸï¼æ„Ÿè¬ç†±å¿ƒå¹«å¿™ã€‚"); closeModals();
            } catch(e) { alert("ç™¼å¸ƒå¤±æ•—ï¼Œè«‹é‡è©¦ï¼"); } finally { btn.disabled = false; btn.innerText = currentReportTab === 'found' ? "ç¢ºèªæ¨™è¨» (+50 åŠŸå¾·)" : "ç™¼å¸ƒæ±‚åŠ©æ¨™è¨˜"; }
        };

        window.previewImage = (input) => {
            const f = input.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height; if(w > 800) { h *= 800/w; w = 800; }
                    canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    document.getElementById('img-preview').src = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('preview-container').classList.remove('hidden'); document.getElementById('upload-placeholder').classList.add('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(f);
        };

        window.closeModals = () => {
            document.getElementById('report-modal').classList.add('hidden'); document.getElementById('nick-hint').innerText = '';
            document.getElementById('in-nick').value = ''; document.getElementById('in-item').value = '';
            document.getElementById('in-floor').value = ''; document.getElementById('in-desc').value = '';
            document.getElementById('img-preview').src = ''; document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
        };
        window.closeDetail = () => document.getElementById('detail-modal').classList.add('hidden');
    </script>
</body>
</html>
